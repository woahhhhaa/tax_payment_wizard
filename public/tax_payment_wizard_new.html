<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tax Payment Wizard (Merged Version)</title>
  <script>
    (function () {
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.get("embed") === "1") {
          document.documentElement.dataset.embed = "1";
        }
      } catch {}
    })();
  </script>
  <style>
    :root {
      --bg: hsl(210 40% 98%);
      --card: hsl(0 0% 100%);
      --fg: hsl(222.2 84% 4.9%);
      --muted: hsl(215.4 16.3% 46.9%);
      --border: hsl(214.3 31.8% 91.4%);
      --accent: hsl(238 74% 56%);
      --accent-hover: hsl(238 74% 50%);
      --success: #10b981;
      --success-hover: #059669;
      --shadow: 0 1px 1px rgba(15, 23, 42, 0.04), 0 8px 28px rgba(15, 23, 42, 0.1);
    }

    html[data-embed="1"] body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    html[data-embed="1"] .wizard-header {
      display: none;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto,
        Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 20px auto;
      max-width: 100%;
      padding: 0 10px;
      background: var(--bg);
      color: var(--fg);
    }
    .container {
      display: grid;
      grid-template-columns: minmax(0, 8fr) minmax(0, 4fr);
      gap: 40px;
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      min-height: calc(100vh - 48px);
      position: relative;
    }
    /* Visual divider */
    .container::after {
      content: '';
      position: absolute;
      right: calc(33.33% + 20px);
      top: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(to bottom,
        transparent 0%,
        #ddd 5%,
        #ddd 95%,
        transparent 100%
      );
    }
    /* Main content area */
    main.wizard-container {
      min-width: 0;
      padding: 24px;
      position: relative;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    /* Sidebar preview */
    aside.preview-container {
      min-width: 0;
      padding: 32px;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 24px;
      height: fit-content;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }
    /* Step progress indicator */
    .step-progress {
      display: flex;
      margin: 0 0 32px;
      padding: 0;
      list-style: none;
      counter-reset: step;
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 1px rgba(15, 23, 42, 0.03), 0 8px 24px rgba(15, 23, 42, 0.08);
    }
    .step-progress li {
      flex: 1;
      position: relative;
      text-align: center;
      counter-increment: step;
      color: #94a3b8;
      font-size: 0.9em;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    .step-progress li.completed {
      color: var(--success);
    }
    .step-progress li.active {
      color: var(--accent);
      font-weight: 600;
    }
    .step-progress li:before {
      content: counter(step);
      width: 32px;
      height: 32px;
      line-height: 32px;
      border: 2px solid #e2e8f0;
      border-radius: 50%;
      display: block;
      margin: 0 auto 8px;
      background: white;
      position: relative;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    .step-progress li.completed:before {
      content: '✓';
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .step-progress li.active:before {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
      box-shadow: 0 0 0 4px hsl(238 74% 56% / 0.12);
    }
    .step-progress li:after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      top: 16px;
      left: -50%;
      z-index: -1;
      transition: background-color 0.3s;
    }
    .step-progress li:first-child:after {
      display: none;
    }
    .step-progress li.completed:after {
      background: #10b981;
    }
    /* Wizard step visibility */
    .wizard-step {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .wizard-step.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* Review step */
    #step-4 {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
    }
    #step-4 .review-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    #step-4 .review-section:last-child {
      border-bottom: none;
    }
    #step-4 h3 {
      color: #1e293b;
      font-size: 1.1em;
      margin: 0 0 16px;
    }
    #step-4 .review-content {
      background: #f8fafc;
      padding: 16px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    /* Buttons */
    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }
    button {
      padding: 12px 24px;
      border: 1px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.5;
      transition: all 0.2s ease;
      background: var(--accent);
      color: white;
    }
    button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18);
    }
    button[type="button"] {
      background: #64748b;
    }
    button[type="button"]:hover {
      background: #475569;
    }
    .primary-button {
      background: var(--success);
      font-size: 16px;
      padding: 14px 28px;
      font-weight: 600;
    }
    .primary-button:hover {
      background: var(--success-hover);
    }
    /* Fieldset styling */
    fieldset {
      border: 1px solid var(--border);
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 14px;
      background: var(--card);
    }
    legend {
      font-size: 1.2em;
      font-weight: 600;
      background: var(--accent);
      color: white;
      padding: 8px 16px;
      border-radius: 10px;
      display: inline-block;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.2s ease;
    }
    /* ... rest of your existing CSS ... */
    legend:hover {
      background: var(--accent-hover);
    }
    /* Form fields */
    .form-field {
      margin: 24px 0;
      position: relative;
    }
    .form-field label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: var(--fg);
    }
    .form-field input[type="text"],
    .form-field input[type="date"],
    .form-field input[type="number"],
    .form-field select,
    .form-field textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1.5;
      background: #ffffff;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18);
    }
    .form-field.error input,
    .form-field.error select {
      border-color: #dc3545;
      background-color: #fff8f8;
      box-shadow: 0 0 0 1px #dc3545;
    }
    .error-message {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 4px;
      display: none;
      font-weight: 500;
    }
    .form-field.error .error-message {
      display: block !important;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Loading indicator */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    .loading.active {
      display: flex;
    }
    .loading::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Table improvements */
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin: 24px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      line-height: 1.5;
      vertical-align: top;
    }
    .stacked-form-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stacked-form-cell label {
      font-weight: 500;
      color: #4a5568;
      font-size: 0.9em;
    }
    .stacked-form-cell select,
    .stacked-form-cell input,
    .stacked-form-cell textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .stacked-form-cell .helper-text {
      font-size: 0.8em;
      color: #718096;
      margin-top: 2px;
    }
    .table-container {
      max-width: 100%;
      overflow-x: auto;
      margin: 24px 0;
      padding-bottom: 6px;
    }
    /* Preview area */
    #previewHeader {
      font-size: 1.2em;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #edf2f7;
      position: relative;
    }
    #previewHeader::after {
      content: 'Live Preview';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75em;
      color: #718096;
      font-weight: 500;
      background: #edf2f7;
      padding: 4px 12px;
      border-radius: 12px;
    }
    .email-preview-container {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }
    .email-header {
      background: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px;
    }
    .email-header-field {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
      font-family: monospace;
      color: #475569;
    }
    .email-header-field:last-child {
      margin-bottom: 0;
    }
    .email-header-label {
      flex: 0 0 80px;
      color: #64748b;
    }
    .email-body {
      padding: 24px;
      background: white;
      min-height: 200px;
      line-height: 1.6;
      color: #2d3748;
    }
    .customize-email {
      margin-top: 16px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .customize-email h3 {
      font-size: 1em;
      color: #475569;
      margin: 0 0 12px;
    }
    .customize-field {
      margin-bottom: 12px;
    }
    .customize-field label {
      display: block;
      font-size: 0.9em;
      color: #64748b;
      margin-bottom: 4px;
    }
    .customize-field input,
    .customize-field textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .customize-field textarea {
      height: 80px;
      resize: vertical;
    }
    #previewArea span[style*="background-color: #FFFF00"] {
      background-color: #fefcbf !important;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    #savePreviewChanges {
      display: none;
      margin-top: 16px;
      background: #48bb78;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    #savePreviewChanges:hover {
      background: #38a169;
    }
    aside.preview-container::-webkit-scrollbar {
      width: 8px;
    }
    aside.preview-container::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 8px;
    }
    aside.preview-container::-webkit-scrollbar-thumb {
      background-color: #cbd5e0;
      border-radius: 8px;
      border: 2px solid #f7fafc;
    }
    aside.preview-container::-webkit-scrollbar-thumb:hover {
      background-color: #a0aec0;
    }
    .preview-edit-notice {
      display: none;
      margin-top: 16px;
      padding: 12px 16px;
      background: #ebf8ff;
      border: 1px solid #bee3f8;
      border-radius: 6px;
      font-size: 0.9em;
      color: #2c5282;
      line-height: 1.5;
    }
    .preview-edit-notice.visible {
      display: block;
    }
    .toggle-switch {
      display: flex;
      align-items: center;
      margin: 16px 0;
      gap: 12px;
    }
    .toggle-switch input[type="checkbox"] {
      height: 0;
      width: 0;
      visibility: hidden;
    }
    .toggle-switch label {
      cursor: pointer;
      width: 50px;
      height: 24px;
      background: #ccc;
      display: block;
      border-radius: 100px;
      position: relative;
      margin-right: 10px;
    }
    .toggle-switch label:after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 20px;
      transition: 0.3s;
    }
    .toggle-switch input:checked + label {
      background: #007bff;
    }
    .toggle-switch input:checked + label:after {
      left: calc(100% - 2px);
      transform: translateX(-100%);
    }
    /* Screen-reader only utility (used in the markup) */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
    /* Focus-visible ring for the custom toggle switch */
    .toggle-switch input[type="checkbox"]:focus-visible + label {
      outline: 3px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }
    .wizard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .wizard-header h2 {
      margin: 0;
      color: #333;
      font-size: 1.75em;
    }
    .state-info-box {
      margin: 24px 0;
      padding: 24px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .state-info-box h3 {
      margin-top: 0;
      font-weight: 600;
      color: #555;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 1200px) {
      .container {
        gap: 30px;
      }
      .container::after {
        right: calc(33.33% + 15px);
      }
      main.wizard-container {
        padding-right: 30px;
      }
    }
    @media (max-width: 1000px) {
      .container {
        grid-template-columns: 1fr;
        gap: 40px;
      }
      .container::after {
        display: none;
      }
      main.wizard-container {
        padding-right: 0;
      }
      aside.preview-container {
        position: static;
        max-height: none;
        margin-top: 40px;
        border-top: 2px solid #eee;
        padding-top: 40px;
      }
    }
    fieldset, table {
      max-width: 100%;
      overflow-x: auto;
    }
    .form-group {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      background: #f8fafc;
    }
    .form-group legend {
      font-size: 1.1em;
      font-weight: 600;
      color: #1e293b;
      background: none;
      padding: 0 8px;
      margin-bottom: 16px;
      box-shadow: none;
    }
    .form-group:hover {
      border-color: #cbd5e0;
      background: #fff;
      transition: all 0.2s ease;
    }
    .wizard-step > fieldset:not(:last-child) {
      margin-bottom: 32px;
    }
    .form-group, .form-field input, .form-field select {
      transition: all 0.2s ease;
    }
    .form-group:focus-within {
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 1px hsl(238 74% 56% / 0.12);
    }
    .add-payment-button {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .add-payment-button:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    .state-section {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    .state-section:hover {
      border-color: #cbd5e0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .state-section h3 {
      color: #1e293b;
      font-size: 1.1em;
      margin: 0 0 16px;
    }
    .form-group table {
      margin: 16px 0 0;
      border: 1px solid #e2e8f0;
    }
    .form-group table th {
      background: #f8fafc;
      color: #1e293b;
      font-weight: 600;
      text-align: left;
    }
    #stateInfoBox.form-group {
      background: #fff;
      border: 1px solid #e2e8f0;
      margin-top: 24px;
    }
    #stateInfoBox.form-group:not(.hidden) {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .helper-text {
      font-size: 0.85em;
      color: #64748b;
      margin: -4px 0 8px;
      font-style: italic;
    }
    .info-tooltip {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #e2e8f0;
      color: #475569;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 6px;
      cursor: help;
    }
    .info-tooltip:hover {
      background: #cbd5e0;
    }
    .save-status {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      color: #64748b;
      font-weight: 600;
    }
    .save-status[data-state="saving"] {
      border-color: #bae6fd;
      background: #e0f2fe;
      color: #0f172a;
    }
    .save-status[data-state="error"] {
      border-color: #fecaca;
      background: #fee2e2;
      color: #b91c1c;
    }
  </style>
</head>
<body>

<div class="loading" id="loadingIndicator" role="alert" aria-busy="true">
  <span class="sr-only">Loading...</span>
</div>

<div class="container">
  <main class="wizard-container" role="main">
	    <div class="wizard-header">
	      <h2>Tax Payment Wizard</h2>
	      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
	        <input
	          id="sessionNameInput"
	          type="text"
	          placeholder="Session name"
	          style="padding:10px;border:1px solid #ddd;border-radius:6px;min-width:260px;"
	          aria-label="Session name"
	        />
	        <button type="button" onclick="newSession()">New Session</button>
	        <button type="button" onclick="saveSessionJson()">Save JSON</button>
	        <button type="button" onclick="triggerLoadSessionJson()">Load JSON</button>
	        <button type="button" onclick="exportSessionCsv()">Export CSV</button>
	        <button type="button" onclick="triggerImportCsv()">Import CSV</button>
	        <button type="button" onclick="generateSessionDrafts()">Download Draft Emails (.zip)</button>
	        <button type="button" onclick="generateChecklistLink()">Generate Checklist Link</button>
	        <button
	          type="button"
	          onclick="reportBug()"
	          aria-label="Report a bug"
	          title="Send a bug report via email"
	        >
	          Report a Bug
	        </button>
          <span id="saveStatus" class="save-status" data-state="idle">Saved</span>

	        <input id="importCsvInput" type="file" accept=".csv,.xlsx,.xls" class="hidden" onchange="importCsvFile(event)">
	        <input id="importJsonInput" type="file" accept=".json" class="hidden" onchange="importSessionJsonFile(event)">
	      </div>
	    </div>

    <!-- Step Progress Indicator -->
    <nav aria-label="Wizard progress">
      <ol class="step-progress">
        <li class="active" aria-current="step">
          <span class="sr-only">Current step: </span>Basic Info
        </li>
        <li>Federal Payments</li>
        <li>State Payments</li>
        <li>Review</li>
      </ol>
	    </nav>

		    <fieldset class="form-group">
		      <legend>Session Clients</legend>

		      <div class="form-field">
		        <label for="clientSelector">Active client</label>
		        <select id="clientSelector" onchange="selectClientFromDropdown()"></select>
		      </div>

		      <div style="display:flex; gap:10px; flex-wrap:wrap;">
		        <button type="button" onclick="createNewClient()">New Client</button>
		        <button type="button" onclick="duplicateActiveClient()">Duplicate</button>
		        <button type="button" onclick="deleteActiveClient()" style="background:#dc3545;">Delete</button>
		      </div>

		      <div id="sessionClientsTable" class="table-container" style="margin-top:16px;"></div>
		    </fieldset>

		    <fieldset class="form-group" id="assistantPanel">
		      <legend>AI Assistant</legend>

		      <div id="assistantStatus" class="helper-text" style="margin-top:0;"></div>

		      <div id="assistantMessages"
		           style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;max-height:220px;overflow:auto;">
		      </div>

		      <div style="display:flex; gap:10px; margin-top:12px; align-items:flex-start;">
		        <textarea id="assistantInput"
		                  placeholder='Try: "Add a new active client Katelynn who needs Q4 estimated taxes due 1/15/2026: federal $5000, CA $2500"'
		                  style="flex:1; min-height:54px; padding:10px; border:1px solid #e2e8f0; border-radius:8px; resize:vertical;"></textarea>
		        <button type="button" id="assistantSendBtn" onclick="assistantSend()">Send</button>
		      </div>

      <div class="helper-text" style="margin-top:8px;">
        This will update your current session + active client. (Requires the `/api/assistant` endpoint.)
      </div>
    </fieldset>

		    <!-- STEP 1: Basic Info -->
		    <fieldset class="wizard-step active" id="step-1" role="tabpanel">
		      <legend>Step 1: Basic Info</legend>
      
      <!-- Recipient & Sender Info -->
      <fieldset class="form-group">
        <legend>Recipient &amp; Sender Info</legend>
        <div class="form-field">
          <label for="addresseeName">Recipient: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Enter the full name as it should appear in the email</div>
          <input type="text"
                 id="addresseeName"
                 placeholder="e.g., John Smith"
                 oninput="onFieldChange()"
                 required
                 aria-required="true"
          />
          <div class="error-message" role="alert"></div>
        </div>

        <div class="form-field">
          <label for="senderName">Sender: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Enter your name as it should appear in the email signature</div>
          <input type="text"
                 id="senderName"
                 placeholder="e.g., Jane Doe"
                 oninput="onFieldChange()"
                 required
                 aria-required="true"
          />
          <div class="error-message" role="alert"></div>
        </div>
      </fieldset>

      <!-- Payment Timing -->
      <fieldset class="form-group">
        <legend>Payment Timing</legend>
        <div class="form-field">
          <label for="paymentDueDate">Pay-by date: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Select a date in MM/DD/YYYY format (must be a future date)</div>
          <input type="date" 
                 id="paymentDueDate" 
                 onchange="onFieldChange()" 
                 required
                 aria-required="true"
          />
          <div class="error-message" role="alert"></div>
          <div id="payByDateWarning" class="helper-text" style="display:none;color:#b45309;margin-top:8px;"></div>

          <div class="toggle-switch">
            <input type="checkbox" 
                   id="showDueDateReminder" 
                   checked 
                   onchange="onFieldChange()"
                   aria-label="Show due date reminder in email"
            />
            <label for="showDueDateReminder"></label>
            <span>Include due date reminder in email</span>
          </div>
        </div>
      </fieldset>

      <!-- Entity Type Selection (Individual vs. Business) -->
      <fieldset class="form-group">
        <legend>Entity Type</legend>
        <div class="form-field">
          <label for="entityType">Select Entity Type: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Choose whether this is for an individual or business entity</div>
          <select id="entityType" onchange="onEntityTypeChange()" required>
            <option value="individual">Individual</option>
            <option value="business">Business Entity</option>
          </select>
          <div class="error-message" role="alert"></div>
        </div>
      </fieldset>

      <!-- Business Information (shown only for business entities) -->
      <fieldset id="businessFields" class="form-group hidden">
        <legend>Business Information</legend>
        <div class="form-field">
          <label for="businessType">Business Type: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Select the type of business entity</div>
          <select id="businessType" onchange="onBusinessTypeChange()">
            <option value="ccorp">C-Corporation</option>
            <option value="scorp">S-Corporation</option>
            <option value="partnership">Partnership</option>
            <option value="llc">Limited Liability Company (LLC)</option>
          </select>
          <div class="error-message" role="alert"></div>
        </div>
        <div class="form-field hidden" id="caCorpFormField">
          <label for="caCorpForm">California Corp Form: <span aria-hidden="true">*</span></label>
          <div class="helper-text">
            Only required if you are a CA C-Corp or S-Corp. (Select Form 100, 100S, 100W, or 100X)
          </div>
          <select id="caCorpForm" onchange="onFieldChange()">
            <option value="">-- Select --</option>
            <option value="Form 100">Form 100</option>
            <option value="Form 100S">Form 100S</option>
            <option value="Form 100W">Form 100W</option>
            <option value="Form 100X">Form 100X</option>
          </select>
          <div class="error-message" role="alert"></div>
        </div>
        <div class="form-field">
          <label for="entityId">Entity ID: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Enter your business entity identification number</div>
          <input type="text" id="entityId" placeholder="e.g., 1234567" required>
          <div class="error-message" role="alert"></div>
        </div>
        <div class="form-field">
          <label for="entityName">Entity Name: <span aria-hidden="true">*</span></label>
          <div class="helper-text">Enter the legal name of your business entity</div>
          <input type="text" id="entityName" placeholder="e.g., ABC Corporation" required>
          <div class="error-message" role="alert"></div>
        </div>
      </fieldset>

      <div class="button-group">
        <button onclick="goToStep(2)" aria-label="Proceed to Federal Payments">Next Step</button>
      </div>
    </fieldset>

    <!-- STEP 2: Federal Payments -->
    <fieldset class="wizard-step" id="step-2">
      <legend>Step 2: Federal Payments</legend>

      <fieldset class="form-group">
        <legend>Federal Payment Details</legend>
        <p>
          Add one or more Federal payments
          <span class="info-tooltip"
                title="Extension: extends filing deadline (not time to pay); Estimated: quarterly payments; Balance Due: payment for a filed return. Instructions differ for individuals vs. businesses.">
            ?
          </span>
        </p>
        <div class="helper-text">
          • Extension (4868) – One-time payment to extend filing deadline (individuals)<br>
          • Estimated (1040-ES) – Quarterly tax payments<br>
          • Balance Due – If you already filed a return and owe additional tax<br>
        </div>
        <button type="button" onclick="addFederalPayment()" class="add-payment-button">+ Add Federal Payment</button>
        <div id="federalPaymentsContainer"></div>
      </fieldset>

      <div class="button-group">
        <button onclick="goToStep(1)">Previous</button>
        <button onclick="goToStep(3)">Next</button>
      </div>
    </fieldset>

    <!-- STEP 3: State Payments -->
    <fieldset class="wizard-step" id="step-3">
      <legend>Step 3: State Payments</legend>
      
      <fieldset class="form-group">
        <legend>Add State</legend>
        <div class="form-field">
          <label for="addStateSelector">
            <strong>Select a State to Add</strong>
            <span class="info-tooltip" 
                  title="Each state has different payment requirements. Select a state to see its specific payment options.">
              ?
            </span>
          </label>
          <div class="helper-text">Choose a state to view its payment requirements and add payments</div>
          <select id="addStateSelector" onchange="onAdditionalStateChange()">
            <option value="">-- Select a state to add --</option>
          </select>
        </div>
      </fieldset>

      <fieldset class="form-group">
        <legend>
          State Payment Details
          <span class="info-tooltip" 
                title="States may offer Extension, Estimated, Balance Due, or PTE (for businesses).">
            ?
          </span>
        </legend>
        <div class="helper-text">
          • Extension: Extends your state filing deadline (not time to pay!)<br>
          • Estimated: Quarterly state tax payments<br>
          • Balance Due / Tax Return Payment: If you filed a return and owe tax<br>
          • PTE: Pass-Through Entity tax (business only in certain states)
        </div>
        <div id="statesContainer">
          <div id="statesList"></div>
        </div>
      </fieldset>

      <fieldset class="form-group hidden" id="stateInfoBox">
        <legend id="stateInfoHeader"></legend>
        <div id="stateInfoContent"></div>
      </fieldset>

      <div class="button-group">
        <button onclick="goToStep(2)">Previous</button>
        <button onclick="goToStep(4)">Next</button>
      </div>
    </fieldset>

    <!-- STEP 4: Review & Confirm -->
    <fieldset class="wizard-step" id="step-4">
      <legend>Step 4: Review & Confirm</legend>
      
      <div class="review-section">
        <h3>Basic Information</h3>
        <div class="review-content">
          <p><strong>Addressee:</strong> <span id="review-addressee"></span></p>
          <p><strong>Due Date:</strong> <span id="review-duedate"></span></p>
          <p><strong>Sender:</strong> <span id="review-sender"></span></p>
        </div>
      </div>

      <div class="review-section">
        <h3>Federal Payments</h3>
        <div class="review-content" id="review-federal"></div>
      </div>

      <div class="review-section">
        <h3>State Payments</h3>
        <div class="review-content" id="review-states"></div>
      </div>

      <!-- NEW: Toggle for disclaimers -->
      <fieldset class="form-group" style="margin-bottom: 0;">
        <legend>Additional Options</legend>
        <div class="form-field">
          <div class="toggle-switch">
            <input type="checkbox" 
                   id="showDisclaimers" 
                   checked 
                   onchange="onFieldChange()"
                   aria-label="Toggle disclaimers in email"
            />
            <label for="showDisclaimers"></label>
            <span>Include "Important Notes & References" disclaimers</span>
          </div>
        </div>
      </fieldset>
      <!-- / NEW: Toggle for disclaimers -->

      <div class="review-section" style="margin-top:24px;">
        <h3>Email Preview</h3>
        <p>The preview on the right shows how your email will appear. If you need to make final adjustments:</p>
        <button onclick="enablePreviewEditing()" class="secondary-button">Enable Final Edits</button>
      </div>

      <div class="button-group">
        <button onclick="goToStep(3)" type="button">Previous</button>
        <button id="downloadButton" onclick="downloadEmlFile()" class="primary-button">Open as Draft Email</button>
      </div>
    </fieldset>

	  </main>

  <aside class="preview-container">
    <div id="previewHeader">Email Preview</div>
    <div id="previewArea" contenteditable="false"></div>
    <div class="preview-edit-notice" aria-live="polite">
      Editing is enabled. Auto-updates stop once you edit the preview directly.
    </div>
    <button id="savePreviewChanges" onclick="savePreviewEdits()" style="display:none;margin-top:10px;">
      Save Preview Changes
    </button>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/******************************************************************************
 * 1) MERGED STATE DATA (FULL) WITH EXTENSION, ESTIMATED, PTE FORMS, ETC.
 *****************************************************************************/
const statesData = {
  "Alabama": {
    extensionFormIndividual: "Form 4868",
    extensionFormBusiness: "Form 7004",
    estimateFormIndividual: "Form 40ES",
    estimateFormBusiness: "Form 65 or 41",
    pteForm: "Form AL-PTE",
    paymentUrlIndividual: "https://myalabamataxes.alabama.gov",
    paymentUrlBusiness: "https://myalabamataxes.alabama.gov",
    taxAgencyName: "Alabama Department of Revenue (ALDOR)",
    estimatedTaxText: "Yes – Individuals must pay quarterly estimates if liability is $500 or more",
    extensionText: "Alabama automatically grants a 6-month extension",
    pteText: "Yes – Alabama allows an elective PTE tax",
    onlinePayProcess: "Payments are made through My Alabama Taxes (MAT)",
    additionalComments: "Alabama personal income tax returns are due April 15"
  },
  "Alaska": {
    extensionFormIndividual: "Form AK-EXT-I",
    extensionFormBusiness: "Form AK-EXT-B",
    estimateFormIndividual: "Form AK-ES-I",
    estimateFormBusiness: "Form AK-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://tax.alaska.gov/programs/onlinepayment.aspx",
    paymentUrlBusiness: "https://tax.alaska.gov/programs/onlinepayment.aspx",
    taxAgencyName: "Alaska Department of Revenue",
    estimatedTaxText: "No personal income tax in Alaska",
    extensionText: "Not applicable for individuals (no personal income tax)",
    pteText: "No – no personal income tax, so PTE is moot",
    onlinePayProcess: "Use Alaska DOR's portal for corporate tax payments",
    additionalComments: "Alaska repealed its individual income tax in 1980"
  },
  "Arizona": {
    extensionFormIndividual: "Form AZ-EXT-I",
    extensionFormBusiness: "Form AZ-EXT-B",
    estimateFormIndividual: "Form AZ-ES-I",
    estimateFormBusiness: "Form AZ-ES-B",
    pteForm: "Form AZ-PTE",
    paymentUrlIndividual: "https://aztaxes.gov/Home/PaymentIndividual",
    paymentUrlBusiness: "https://aztaxes.gov/Home/PaymentBusiness",
    taxAgencyName: "Arizona Department of Revenue (AZDOR)",
    estimatedTaxText: "Yes – Must pay quarterly if expecting to owe $1,000+",
    extensionText: "AZ generally follows federal extension",
    pteText: "Yes – elective PTE tax began in 2022",
    onlinePayProcess: "Use AZTaxes.gov for online payments",
    additionalComments: "AZ returns due April 15"
  },
  "Arkansas": {
    extensionFormIndividual: "Form AR-EXT-I",
    extensionFormBusiness: "Form AR-EXT-B",
    estimateFormIndividual: "Form AR-ES-I",
    estimateFormBusiness: "Form AR-ES-B",
    pteForm: "Form AR-PTE",
    paymentUrlIndividual: "https://www.dfa.arkansas.gov/service/make-an-income-tax-payment",
    paymentUrlBusiness: "https://www.dfa.arkansas.gov/service/make-a-business-tax-payment",
    taxAgencyName: "Arkansas Department of Finance and Administration",
    estimatedTaxText: "Yes – If you'll owe more than $1,000",
    extensionText: "Automatic 6-month extension (until Oct 15)",
    pteText: "Yes – elective PTE tax from 2022",
    onlinePayProcess: "Use ATAP (Arkansas Taxpayer Access Point)",
    additionalComments: "Arkansas personal returns due April 15"
  },
  "California": {
    extensionFormIndividual: "Form 3519",
    extensionFormBusiness: "FTB 3539",
    estimateFormIndividual: "Form 540-ES",
    estimateFormBusiness: "Form 100-ES",
    pteForm: "Form 3893",
    paymentUrlIndividual: "https://webapp.ftb.ca.gov/webpay/login/login?Submit=Use+Web+Pay+personal",
    paymentUrlBusiness: "https://webapp.ftb.ca.gov/webpay/login/belogin?Submit=Use+Web+Pay+business",
    taxAgencyName: "California Franchise Tax Board (FTB)",
    estimatedTaxText: "Yes – CA requires estimated tax if you owe $500+",
    extensionText: "CA automatically grants a 6-month extension",
    pteText: "Yes – CA has an elective PTE tax (AB 150)",
    onlinePayProcess: "Use FTB Web Pay on Franchise Tax Board website",
    additionalComments: "California's PTE is a popular SALT workaround",

    /* Payment Type Maps for business filers */
    corpScorpPaymentTypes: {
      estimatedPayment: {
        label: "Estimated Tax Payment",
        form: "100ES"
      },
      extensionPayment: {
        label: "Extension Payment",
        form: "3539"
      },
      originalReturnPayment: {
        label: "Original Return Payment",
        form: "100, 100S, 100W, or 3586"
      },
      billPayment: {
        label: "Bill Payment"
      },
      sosPenalty: {
        label: "Secretary of State (SOS) Certification Penalty Payment"
      },
      amendedReturn: {
        label: "Amended Return Payment",
        form: "100X"
      },
      npaPayment: {
        label: "Notice of Proposed Assessment (NPA) Payment",
        form: "NPA Payment"
      },
      pendingAudit: {
        label: "Pending Audit Tax Deposit Payment",
        form: "3577"
      },
      pte: {
        label: "Pass-Through Entity Elective Tax",
        form: "3893"
      }
    },
    llcPaymentTypes: {
      annualTax: {
        label: "Annual Tax Payment",
        form: "3522"
      },
      estimatedFee: {
        label: "Estimated Fee Payment",
        form: "3536"
      },
      extensionNcnr: {
        label: "Extension / NCNR Member Payment",
        form: "3537"
      },
      originalReturnNcnr: {
        label: "Original Return / NCNR Member Payment",
        form: "568 or 3588"
      },
      billPayment: {
        label: "Bill Payment"
      },
      sosPenalty: {
        label: "Secretary of State (SOS) Certification Penalty Payment"
      },
      amendedReturn: {
        label: "Amended Return Payment",
        form: "568"
      },
      npaPayment: {
        label: "Notice of Proposed Assessment (NPA) Payment",
        form: "NPA Payment (3578)"
      },
      pendingAudit: {
        label: "Pending Audit Tax Deposit Payment",
        form: "3578"
      },
      pte: {
        label: "Pass-Through Entity Elective Tax",
        form: "3893"
      }
    },
    partnershipPaymentTypes: {
      originalReturnPayment: {
        label: "Original Return Payment",
        form: "565 or 3587"
      },
      extensionPayment: {
        label: "Extension Payment",
        form: "3538"
      },
      billPayment: {
        label: "Bill Payment"
      },
      amendedReturn: {
        label: "Amended Return Payment",
        form: "565"
      },
      npaPayment: {
        label: "Notice of Proposed Assessment (NPA) Payment",
        form: "NPA Payment (3579)"
      },
      pendingAudit: {
        label: "Pending Audit Tax Deposit Payment",
        form: "3579"
      },
      pte: {
        label: "Pass-Through Entity Elective Tax",
        form: "3893"
      }
    }
  },
  "Colorado": {
    extensionFormIndividual: "Form CO-EXT-I",
    extensionFormBusiness: "Form CO-EXT-B",
    estimateFormIndividual: "Form CO-ES-I",
    estimateFormBusiness: "Form CO-ES-B",
    pteForm: "Form CO-PTE",
    paymentUrlIndividual: "https://revenueonline.colorado.gov",
    paymentUrlBusiness: "https://revenueonline.colorado.gov",
    taxAgencyName: "Colorado Department of Revenue",
    estimatedTaxText: "Yes – Follows federal guidelines for estimated tax",
    extensionText: "CO automatically allows 6-month extension",
    pteText: "Yes – elective PTE from 2022",
    onlinePayProcess: "Use Colorado's Revenue Online",
    additionalComments: "CO income tax is flat (4.4%)"
  },
  "Connecticut": {
    extensionFormIndividual: "Form CT-1040 EXT",
    extensionFormBusiness: "Form CT-1120 EXT",
    estimateFormIndividual: "Form CT-1040ES",
    estimateFormBusiness: "Form CT-1120 ESA/ESB/ESC/ESD",
    pteForm: "Form CT-1065/CT-1120SI",
    paymentUrlIndividual: "https://portal.ct.gov/drs/tsc/myconnect",
    paymentUrlBusiness: "https://portal.ct.gov/drs/tsc/myconnect",
    taxAgencyName: "Connecticut Department of Revenue Services (DRS)",
    estimatedTaxText: "Yes – generally follows federal rules",
    extensionText: "Requires extension request if you cannot file by Apr 15",
    pteText: "Yes – first state SALT workaround (PTE Tax)",
    onlinePayProcess: "Use CT Taxpayer Service Center (TSC)",
    additionalComments: "Unique approach"
  },
  "Delaware": {
    extensionFormIndividual: "Form DE-EXT-I",
    extensionFormBusiness: "Form DE-EXT-B",
    estimateFormIndividual: "Form DE-ES-I",
    estimateFormBusiness: "Form DE-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://revenue.delaware.gov/online-services",
    paymentUrlBusiness: "https://revenue.delaware.gov/online-services",
    taxAgencyName: "Delaware Division of Revenue",
    estimatedTaxText: "Yes – if you'll owe more than $400",
    extensionText: "DE personal returns due April 30",
    pteText: "No – Delaware has not enacted SALT workaround PTE",
    onlinePayProcess: "Use Delaware's Taxpayer Portal",
    additionalComments: "DE's filing deadline is April 30"
  },
  "Florida": {
    extensionFormIndividual: "Form FL-EXT-I",
    extensionFormBusiness: "Form FL-EXT-B",
    estimateFormIndividual: "Form FL-ES-I",
    estimateFormBusiness: "Form FL-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://floridarevenue.com/taxes/Pages/epay.aspx",
    paymentUrlBusiness: "https://floridarevenue.com/taxes/Pages/epay.aspx",
    taxAgencyName: "Florida Department of Revenue",
    estimatedTaxText: "Florida has no state personal income tax",
    extensionText: "No personal tax extension needed",
    pteText: "No – no personal income tax",
    onlinePayProcess: "FL DOR e-Services for business",
    additionalComments: "Florida doesn't tax individual income"
  },
  "Georgia": {
    extensionFormIndividual: "Form GA-EXT-I",
    extensionFormBusiness: "Form GA-EXT-B",
    estimateFormIndividual: "Form GA-ES-I",
    estimateFormBusiness: "Form GA-ES-B",
    pteForm: "Form GA-PTE",
    paymentUrlIndividual: "https://gtc.dor.ga.gov",
    paymentUrlBusiness: "https://gtc.dor.ga.gov",
    taxAgencyName: "Georgia Department of Revenue",
    estimatedTaxText: "Yes – if you expect to owe $500+",
    extensionText: "GA personal returns due April 15",
    pteText: "Yes – GA enacted elective PTE for 2022+",
    onlinePayProcess: "Use Georgia Tax Center (GTC)",
    additionalComments: "Pass-Through Entity Election Tax"
  },
  "Hawaii": {
    extensionFormIndividual: "Form N-101A",
    extensionFormBusiness: "Form N-301",
    estimateFormIndividual: "Form N-200V",
    estimateFormBusiness: "Form N-301",
    pteForm: "Form N-35",
    paymentUrlIndividual: "https://hitax.hawaii.gov",
    paymentUrlBusiness: "https://hitax.hawaii.gov",
    taxAgencyName: "Hawaii Department of Taxation",
    estimatedTaxText: "Yes – must pay if you'll owe $500+",
    extensionText: "HI personal returns due April 20",
    pteText: "Yes – adopted elective PTE from 2023",
    onlinePayProcess: "Use Hawaii Tax Online (HTO)",
    additionalComments: "Hawaii's top rate is ~11%"
  },
  "Idaho": {
    extensionFormIndividual: "Form ID-EXT-I",
    extensionFormBusiness: "Form ID-EXT-B",
    estimateFormIndividual: "Form ID-ES-I",
    estimateFormBusiness: "Form ID-ES-B",
    pteForm: "Form ID-PTE",
    paymentUrlIndividual: "https://tax.idaho.gov/online-services",
    paymentUrlBusiness: "https://tax.idaho.gov/online-services",
    taxAgencyName: "Idaho State Tax Commission",
    estimatedTaxText: "Yes – if you expect to owe $200+",
    extensionText: "ID accepts federal extension",
    pteText: "Yes – from tax year 2021",
    onlinePayProcess: "Use Idaho's TAP",
    additionalComments: "Called 'Entity Level Tax'"
  },
  "Illinois": {
    extensionFormIndividual: "Form IL-EXT-I",
    extensionFormBusiness: "Form IL-EXT-B",
    estimateFormIndividual: "Form IL-ES-I",
    estimateFormBusiness: "Form IL-ES-B",
    pteForm: "Form IL-PTE",
    paymentUrlIndividual: "https://mytax.illinois.gov",
    paymentUrlBusiness: "https://mytax.illinois.gov",
    taxAgencyName: "Illinois Department of Revenue",
    estimatedTaxText: "Yes – must pay if you expect to owe $1,000",
    extensionText: "IL personal returns due April 15, automatic extension",
    pteText: "Yes – 'Illinois Pass-through Entity (PTE) Tax'",
    onlinePayProcess: "Use MyTax Illinois portal",
    additionalComments: "Enacted by P.A. 102-0658"
  },
  "Indiana": {
    extensionFormIndividual: "Form IN-EXT-I",
    extensionFormBusiness: "Form IN-EXT-B",
    estimateFormIndividual: "Form IN-ES-I",
    estimateFormBusiness: "Form IN-ES-B",
    pteForm: "Form IN-PTE",
    paymentUrlIndividual: "https://dor.in.gov/online-services",
    paymentUrlBusiness: "https://dor.in.gov/online-services",
    taxAgencyName: "Indiana Department of Revenue (DOR)",
    estimatedTaxText: "Yes – if expecting to owe $1,000",
    extensionText: "Recognizes valid federal extension",
    pteText: "Yes – enacted in 2023",
    onlinePayProcess: "Use Indiana's INTIME portal",
    additionalComments: "Called the 'SALT workaround' in Indiana"
  },
  "Iowa": {
    extensionFormIndividual: "Form IA-EXT-I",
    extensionFormBusiness: "Form IA-EXT-B",
    estimateFormIndividual: "Form IA-ES-I",
    estimateFormBusiness: "Form IA-ES-B",
    pteForm: "Form IA-PTE",
    paymentUrlIndividual: "https://tax.iowa.gov/epay",
    paymentUrlBusiness: "https://tax.iowa.gov/epay",
    taxAgencyName: "Iowa Department of Revenue",
    estimatedTaxText: "Yes – if you expect to owe > $200",
    extensionText: "Automatically grants extension until Oct 31",
    pteText: "Yes – established in 2022",
    onlinePayProcess: "Use GovConnectIowa",
    additionalComments: "Applies to tax years 2022+"
  },
  "Kansas": {
    extensionFormIndividual: "Form KS-EXT-I",
    extensionFormBusiness: "Form KS-EXT-B",
    estimateFormIndividual: "Form KS-ES-I",
    estimateFormBusiness: "Form KS-ES-B",
    pteForm: "Form KS-PTE",
    paymentUrlIndividual: "https://ksrevenue.org/epay.html",
    paymentUrlBusiness: "https://ksrevenue.org/epay.html",
    taxAgencyName: "Kansas Department of Revenue",
    estimatedTaxText: "Yes – if you expect to owe $500+",
    extensionText: "Honors federal extension",
    pteText: "Yes – 'SALT Parity Act' 2022",
    onlinePayProcess: "Use Kansas Customer Service Center or WebTax",
    additionalComments: "HB 2239 was an early adopter"
  },
  "Kentucky": {
    extensionFormIndividual: "Form KY-EXT-I",
    extensionFormBusiness: "Form KY-EXT-B",
    estimateFormIndividual: "Form KY-ES-I",
    estimateFormBusiness: "Form KY-ES-B",
    pteForm: "Form KY-PTE",
    paymentUrlIndividual: "https://epayment.ky.gov",
    paymentUrlBusiness: "https://epayment.ky.gov",
    taxAgencyName: "Kentucky Department of Revenue",
    estimatedTaxText: "Yes – if you owe at least $500",
    extensionText: "Accepts federal extension",
    pteText: "Yes – passed PTE in 2023",
    onlinePayProcess: "Use KY E-File/E-Pay or mail vouchers",
    additionalComments: "KY has a flat 4.5% rate"
  },
  "Louisiana": {
    extensionFormIndividual: "Form LA-EXT-I",
    extensionFormBusiness: "Form LA-EXT-B",
    estimateFormIndividual: "Form LA-ES-I",
    estimateFormBusiness: "Form LA-ES-B",
    pteForm: "Form LA-PTE",
    paymentUrlIndividual: "https://latap.revenue.louisiana.gov",
    paymentUrlBusiness: "https://latap.revenue.louisiana.gov",
    taxAgencyName: "Louisiana Department of Revenue (LDR)",
    estimatedTaxText: "Yes – if you expect to owe $1,000+ beyond withholding",
    extensionText: "Requires extension request if needed",
    pteText: "Yes – certain pass-throughs can elect C-corp treatment",
    onlinePayProcess: "Use Louisiana Taxpayer Access Point (LaTAP)",
    additionalComments: "Predates post-2018 SALT workaround trend"
  },
  "Maine": {
    extensionFormIndividual: "Form ME-EXT-I",
    extensionFormBusiness: "Form ME-EXT-B",
    estimateFormIndividual: "Form ME-ES-I",
    estimateFormBusiness: "Form ME-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://revenue.maine.gov/online-services",
    paymentUrlBusiness: "https://revenue.maine.gov/online-services",
    taxAgencyName: "Maine Revenue Services (MRS)",
    estimatedTaxText: "Yes – if you expect to owe $1,000",
    extensionText: "Generally honors federal extension",
    pteText: "No – hasn't enacted SALT workaround yet",
    onlinePayProcess: "Use Maine EZ Pay or Maine Tax Portal",
    additionalComments: "Considered SALT workaround in 2021 but not passed"
  },
  "Maryland": {
    extensionFormIndividual: "Form MD-EXT-I",
    extensionFormBusiness: "Form MD-EXT-B",
    estimateFormIndividual: "Form MD-ES-I",
    estimateFormBusiness: "Form MD-ES-B",
    pteForm: "Form MD-PTE",
    paymentUrlIndividual: "https://interactive.marylandtaxes.gov",
    paymentUrlBusiness: "https://interactive.marylandtaxes.gov",
    taxAgencyName: "Comptroller of Maryland, Revenue Administration",
    estimatedTaxText: "Yes – if you expect to owe $500+ in state & local",
    extensionText: "File Form 502 E if needed",
    pteText: "Yes – elective PTE since 2020",
    onlinePayProcess: "Use BillPay or bFile",
    additionalComments: "PTE tax is very popular in MD"
  },
  "Massachusetts": {
    extensionFormIndividual: "Form MA-EXT-I",
    extensionFormBusiness: "Form MA-EXT-B",
    estimateFormIndividual: "Form MA-ES-I",
    estimateFormBusiness: "Form MA-ES-B",
    pteForm: "Form MA-PTE",
    paymentUrlIndividual: "https://mtc.dor.state.ma.us",
    paymentUrlBusiness: "https://mtc.dor.state.ma.us",
    taxAgencyName: "Massachusetts Department of Revenue (DOR)",
    estimatedTaxText: "Yes – if you expect to owe more than $400",
    extensionText: "Automatic 6-month extension (to Oct 15)",
    pteText: "Yes – elective pass-through entity excise",
    onlinePayProcess: "Use MassTaxConnect",
    additionalComments: "Complex partial credit for PTE"
  },
  "Michigan": {
    extensionFormIndividual: "Form MI-EXT-I",
    extensionFormBusiness: "Form MI-EXT-B",
    estimateFormIndividual: "Form MI-ES-I",
    estimateFormBusiness: "Form MI-ES-B",
    pteForm: "Form MI-PTE",
    paymentUrlIndividual: "https://treasury.michigan.gov/epay",
    paymentUrlBusiness: "https://treasury.michigan.gov/epay",
    taxAgencyName: "Michigan Department of Treasury",
    estimatedTaxText: "Yes – if you expect to owe $500+",
    extensionText: "Automatic 6-month extension",
    pteText: "Yes – Flow-Through Entity Tax (FTET) from 2021",
    onlinePayProcess: "Use Michigan Treasury Online (MTO)",
    additionalComments: "Flat 4.25% in/out"
  },
  "Minnesota": {
    extensionFormIndividual: "Form M-15",
    extensionFormBusiness: "Form M-706",
    estimateFormIndividual: "Form M-14",
    estimateFormBusiness: "Form M-18",
    pteForm: "Form PTE",
    paymentUrlIndividual: "https://eservices.mndor.state.mn.us",
    paymentUrlBusiness: "https://eservices.mndor.state.mn.us",
    taxAgencyName: "Minnesota Department of Revenue",
    estimatedTaxText: "Yes – if you expect to owe $500+ after credits/withholding",
    extensionText: "Automatic extension to Oct 15",
    pteText: "Yes – enacted 2021, top rate can be 9.85%",
    onlinePayProcess: "Use MN e-Services",
    additionalComments: "One of highest PTE rates"
  },
  "Mississippi": {
    extensionFormIndividual: "Form MS-EXT-I",
    extensionFormBusiness: "Form MS-EXT-B",
    estimateFormIndividual: "Form MS-ES-I",
    estimateFormBusiness: "Form MS-ES-B",
    pteForm: "Form MS-PTE",
    paymentUrlIndividual: "https://tap.dor.ms.gov",
    paymentUrlBusiness: "https://tap.dor.ms.gov",
    taxAgencyName: "Mississippi Department of Revenue",
    estimatedTaxText: "Standard procedures, must pay if owed",
    extensionText: "Likely follows fed extension; see MS-EXT forms",
    pteText: "Yes – assumed available",
    onlinePayProcess: "Use TAP",
    additionalComments: "Generic MS approach"
  },
  "Missouri": {
    extensionFormIndividual: "Form MO-EXT-I",
    extensionFormBusiness: "Form MO-EXT-B",
    estimateFormIndividual: "Form MO-ES-I",
    estimateFormBusiness: "Form MO-ES-B",
    pteForm: "Form MO-PTE",
    paymentUrlIndividual: "https://dor.mo.gov/online-services",
    paymentUrlBusiness: "https://dor.mo.gov/online-services",
    taxAgencyName: "Missouri Department of Revenue",
    estimatedTaxText: "Standard typical tax procedures",
    extensionText: "Accepts fed extension",
    pteText: "Yes – generic PTE form if applicable",
    onlinePayProcess: "Use MO online services",
    additionalComments: "SALT workaround possible"
  },
  "Montana": {
    extensionFormIndividual: "Form MT-EXT-I",
    extensionFormBusiness: "Form MT-EXT-B",
    estimateFormIndividual: "Form MT-ES-I",
    estimateFormBusiness: "Form MT-ES-B",
    pteForm: "Form MT-PTE",
    paymentUrlIndividual: "https://mtrevenue.gov/online-services",
    paymentUrlBusiness: "https://mtrevenue.gov/online-services",
    taxAgencyName: "Montana Department of Revenue",
    estimatedTaxText: "Standard guidelines",
    extensionText: "Follows typical extension rules",
    pteText: "Generic PTE form",
    onlinePayProcess: "Use MT Revenue online",
    additionalComments: "No special notes"
  },
  "Nebraska": {
    extensionFormIndividual: "Form NE-EXT-I",
    extensionFormBusiness: "Form NE-EXT-B",
    estimateFormIndividual: "Form NE-ES-I",
    estimateFormBusiness: "Form NE-ES-B",
    pteForm: "Form NE-PTE",
    paymentUrlIndividual: "https://revenue.nebraska.gov/online-services",
    paymentUrlBusiness: "https://revenue.nebraska.gov/online-services",
    taxAgencyName: "Nebraska Department of Revenue",
    estimatedTaxText: "Follows general tax practices",
    extensionText: "Honors fed extension for individuals",
    pteText: "Yes – form NE-PTE if enacted",
    onlinePayProcess: "Use NE revenue online",
    additionalComments: "No special notes"
  },
  "Nevada": {
    extensionFormIndividual: "Form NV-EXT-I",
    extensionFormBusiness: "Form NV-EXT-B",
    estimateFormIndividual: "Form NV-ES-I",
    estimateFormBusiness: "Form NV-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://tax.nv.gov/online-services",
    paymentUrlBusiness: "https://tax.nv.gov/online-services",
    taxAgencyName: "Nevada Department of Taxation",
    estimatedTaxText: "No personal income tax",
    extensionText: "No personal extension needed",
    pteText: "No – no personal income tax",
    onlinePayProcess: "Nevada Tax portal",
    additionalComments: "No individual income tax"
  },
  "New Hampshire": {
    extensionFormIndividual: "Form NH-EXT-I",
    extensionFormBusiness: "Form NH-EXT-B",
    estimateFormIndividual: "Form NH-ES-I",
    estimateFormBusiness: "Form NH-ES-B",
    pteForm: "Form NH-PTE",
    paymentUrlIndividual: "https://revenue.nh.gov/online-services",
    paymentUrlBusiness: "https://revenue.nh.gov/online-services",
    taxAgencyName: "New Hampshire Department of Revenue",
    estimatedTaxText: "NH taxes dividends/interest, phasing out",
    extensionText: "Standard approach if needed",
    pteText: "Placeholder for pass-through entity provisions",
    onlinePayProcess: "Use NH DOR's online services",
    additionalComments: "Phasing out interest/dividends tax by 2027"
  },
  "New Jersey": {
    extensionFormIndividual: "Form NJ-EXT-I",
    extensionFormBusiness: "Form NJ-EXT-B",
    estimateFormIndividual: "Form NJ-ES-I",
    estimateFormBusiness: "Form NJ-ES-B",
    pteForm: "Form NJ-PTE",
    paymentUrlIndividual: "https://www.nj.gov/treasury/taxation/njtaxpay.shtml",
    paymentUrlBusiness: "https://www.nj.gov/treasury/taxation/njtaxpay.shtml",
    taxAgencyName: "New Jersey Division of Taxation",
    estimatedTaxText: "Follows typical practices",
    extensionText: "Use NJ extension forms",
    pteText: "Yes – assumed PTE forms available",
    onlinePayProcess: "NJTAXPAY site",
    additionalComments: "One of earliest SALT workaround states"
  },
  "New Mexico": {
    extensionFormIndividual: "Form NM-EXT-I",
    extensionFormBusiness: "Form NM-EXT-B",
    estimateFormIndividual: "Form NM-ES-I",
    estimateFormBusiness: "Form NM-ES-B",
    pteForm: "Form NM-PTE",
    paymentUrlIndividual: "https://tap.state.nm.us",
    paymentUrlBusiness: "https://tap.state.nm.us",
    taxAgencyName: "New Mexico Taxation and Revenue",
    estimatedTaxText: "Follows standard federal guidelines",
    extensionText: "Use NM extension forms if needed",
    pteText: "Yes – generic NM PTE approach",
    onlinePayProcess: "Use TAP",
    additionalComments: "SALT workaround in effect"
  },
  "New York": {
    extensionFormIndividual: "Form IT-370",
    extensionFormBusiness: "Form CT-5",
    estimateFormIndividual: "Form IT-2105",
    estimateFormBusiness: "Form CT-400",
    pteForm: "Form IT-204",
    paymentUrlIndividual: "https://www.tax.ny.gov/online",
    paymentUrlBusiness: "https://www.tax.ny.gov/online",
    taxAgencyName: "New York State Department of Taxation and Finance",
    estimatedTaxText: "Yes – if you expect to owe tax not covered by withholding",
    extensionText: "IT-370 for personal, CT-5 for business",
    pteText: "Yes – IT-204 for PTE",
    onlinePayProcess: "NY.gov tax online",
    additionalComments: "NY has separate city taxes too"
  },
  "North Carolina": {
    extensionFormIndividual: "Form NC-EXT-I",
    extensionFormBusiness: "Form NC-EXT-B",
    estimateFormIndividual: "Form NC-ES-I",
    estimateFormBusiness: "Form NC-ES-B",
    pteForm: "Form NC-PTE",
    paymentUrlIndividual: "https://eservices.dor.nc.gov",
    paymentUrlBusiness: "https://eservices.dor.nc.gov",
    taxAgencyName: "North Carolina Department of Revenue",
    estimatedTaxText: "Follows standard rules",
    extensionText: "Accepts fed extension or NC-EXT",
    pteText: "Yes – with state SALT workaround",
    onlinePayProcess: "Use NC eServices",
    additionalComments: "NC deadlines align with federal"
  },
  "North Dakota": {
    extensionFormIndividual: "Form ND-EXT-I",
    extensionFormBusiness: "Form ND-EXT-B",
    estimateFormIndividual: "Form ND-ES-I",
    estimateFormBusiness: "Form ND-ES-B",
    pteForm: "Form ND-PTE",
    paymentUrlIndividual: "https://tap.tax.nd.gov",
    paymentUrlBusiness: "https://tap.tax.nd.gov",
    taxAgencyName: "North Dakota Office of State Tax Commissioner",
    estimatedTaxText: "Yes – typical guidelines",
    extensionText: "Follows fed extension",
    pteText: "Placeholder ND-PTE",
    onlinePayProcess: "Use ND TAP",
    additionalComments: "No special notes"
  },
  "Ohio": {
    extensionFormIndividual: "Form OH-EXT-I",
    extensionFormBusiness: "Form OH-EXT-B",
    estimateFormIndividual: "Form OH-ES-I",
    estimateFormBusiness: "Form OH-ES-B",
    pteForm: "Form OH-PTE",
    paymentUrlIndividual: "https://tax.ohio.gov/online-services",
    paymentUrlBusiness: "https://tax.ohio.gov/online-services",
    taxAgencyName: "Ohio Department of Taxation",
    estimatedTaxText: "Follows general procedures",
    extensionText: "Accepts fed extension",
    pteText: "Yes – if legislated",
    onlinePayProcess: "Use Ohio Tax online",
    additionalComments: "No special notes"
  },
  "Oklahoma": {
    extensionFormIndividual: "Form OK-EXT-I",
    extensionFormBusiness: "Form OK-EXT-B",
    estimateFormIndividual: "Form OK-ES-I",
    estimateFormBusiness: "Form OK-ES-B",
    pteForm: "Form OK-PTE",
    paymentUrlIndividual: "https://oktap.tax.ok.gov",
    paymentUrlBusiness: "https://oktap.tax.ok.gov",
    taxAgencyName: "Oklahoma Tax Commission",
    estimatedTaxText: "Standard rules",
    extensionText: "OK extension forms if needed",
    pteText: "Yes – SALT workaround",
    onlinePayProcess: "Use OKTAP",
    additionalComments: "No special notes"
  },
  "Oregon": {
    extensionFormIndividual: "Form OR-40-EXT",
    extensionFormBusiness: "Form OR-37",
    estimateFormIndividual: "Form OR-40-V",
    estimateFormBusiness: "Form OR-20-V",
    pteForm: "Form OR-PTE",
    paymentUrlIndividual: "https://revenueonline.dor.oregon.gov",
    paymentUrlBusiness: "https://revenueonline.dor.oregon.gov",
    taxAgencyName: "Oregon Department of Revenue",
    estimatedTaxText: "Specific forms for estimates (OR-40-V or OR-20-V)",
    extensionText: "OR-40-EXT or OR-37",
    pteText: "Form OR-PTE for pass-through entity tax",
    onlinePayProcess: "Use Revenue Online",
    additionalComments: "Popular SALT workaround state"
  },
  "Pennsylvania": {
    extensionFormIndividual: "Form REV-276",
    extensionFormBusiness: "Form REV-276",
    estimateFormIndividual: "Form PA-40 ES",
    estimateFormBusiness: "Form PA-40 ESB",
    pteForm: "Form PA-20S/PA-65",
    paymentUrlIndividual: "https://mytax.pa.gov",
    paymentUrlBusiness: "https://mytax.pa.gov",
    taxAgencyName: "Pennsylvania Department of Revenue",
    estimatedTaxText: "Separate forms for individuals & business estimates",
    extensionText: "REV-276 for both individuals & businesses",
    pteText: "Form PA-20S/PA-65",
    onlinePayProcess: "Use myPATH",
    additionalComments: "REV-276 extends personal & business"
  },
  "Rhode Island": {
    extensionFormIndividual: "Form RI-EXT-I",
    extensionFormBusiness: "Form RI-EXT-B",
    estimateFormIndividual: "Form RI-ES-I",
    estimateFormBusiness: "Form RI-ES-B",
    pteForm: "Form RI-PTE",
    paymentUrlIndividual: "https://tax.ri.gov/online-services",
    paymentUrlBusiness: "https://tax.ri.gov/online-services",
    taxAgencyName: "Rhode Island Division of Taxation",
    estimatedTaxText: "Follows typical guidelines",
    extensionText: "Use RI-EXT forms",
    pteText: "Yes – placeholder forms for pass-through",
    onlinePayProcess: "Use RI online services",
    additionalComments: "Generic approach"
  },
  "South Carolina": {
    extensionFormIndividual: "Form SC-EXT-I",
    extensionFormBusiness: "Form SC-EXT-B",
    estimateFormIndividual: "Form SC-ES-I",
    estimateFormBusiness: "Form SC-ES-B",
    pteForm: "Form SC-PTE",
    paymentUrlIndividual: "https://mydorway.dor.sc.gov",
    paymentUrlBusiness: "https://mydorway.dor.sc.gov",
    taxAgencyName: "South Carolina Department of Revenue",
    estimatedTaxText: "Standard rules if owing tax",
    extensionText: "Accepts extension forms or fed extension",
    pteText: "Yes – SC pass-through entity tax",
    onlinePayProcess: "Use MyDORWAY",
    additionalComments: "No special notes"
  },
  "South Dakota": {
    extensionFormIndividual: "Form SD-EXT-I",
    extensionFormBusiness: "Form SD-EXT-B",
    estimateFormIndividual: "Form SD-ES-I",
    estimateFormBusiness: "Form SD-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://dor.sd.gov/online-services",
    paymentUrlBusiness: "https://dor.sd.gov/online-services",
    taxAgencyName: "South Dakota Department of Revenue",
    estimatedTaxText: "No personal income tax",
    extensionText: "No personal extension needed",
    pteText: "No – no personal income tax",
    onlinePayProcess: "Use SD online services",
    additionalComments: "No personal income tax"
  },
  "Tennessee": {
    extensionFormIndividual: "Form TN-EXT-I",
    extensionFormBusiness: "Form TN-EXT-B",
    estimateFormIndividual: "Form TN-ES-I",
    estimateFormBusiness: "Form TN-ES-B",
    pteForm: "Form TN-PTE",
    paymentUrlIndividual: "https://tntap.tn.gov",
    paymentUrlBusiness: "https://tntap.tn.gov",
    taxAgencyName: "Tennessee Department of Revenue",
    estimatedTaxText: "TN had Hall tax, now phased out",
    extensionText: "Generic forms if needed",
    pteText: "Yes – placeholder PTE forms",
    onlinePayProcess: "Use TNTAP",
    additionalComments: "No broad personal income tax"
  },
  "Texas": {
    extensionFormIndividual: "Form TX-EXT-I",
    extensionFormBusiness: "Form TX-EXT-B",
    estimateFormIndividual: "Form TX-ES-I",
    estimateFormBusiness: "Form TX-ES-B",
    pteForm: "Form TX-PTE",
    paymentUrlIndividual: "https://comptroller.texas.gov/taxes/file-pay",
    paymentUrlBusiness: "https://comptroller.texas.gov/taxes/file-pay",
    taxAgencyName: "Texas Comptroller of Public Accounts",
    estimatedTaxText: "No personal income tax in TX",
    extensionText: "Not required for personal",
    pteText: "Yes – if for franchise taxes or PTE?",
    onlinePayProcess: "Use Texas eSystems",
    additionalComments: "TX has a franchise tax"
  },
  "Utah": {
    extensionFormIndividual: "Form UT-EXT-I",
    extensionFormBusiness: "Form UT-EXT-B",
    estimateFormIndividual: "Form UT-ES-I",
    estimateFormBusiness: "Form UT-ES-B",
    pteForm: "Form UT-PTE",
    paymentUrlIndividual: "https://tap.utah.gov",
    paymentUrlBusiness: "https://tap.utah.gov",
    taxAgencyName: "Utah State Tax Commission",
    estimatedTaxText: "Standard approach",
    extensionText: "Use UT-EXT forms",
    pteText: "Yes – UT PTE as SALT workaround",
    onlinePayProcess: "Use TAP",
    additionalComments: "No special notes"
  },
  "Vermont": {
    extensionFormIndividual: "Form VT-EXT-I",
    extensionFormBusiness: "Form VT-EXT-B",
    estimateFormIndividual: "Form VT-ES-I",
    estimateFormBusiness: "Form VT-ES-B",
    pteForm: "Form VT-PTE",
    paymentUrlIndividual: "https://mytax.vermont.gov",
    paymentUrlBusiness: "https://mytax.vermont.gov",
    taxAgencyName: "Vermont Department of Taxes",
    estimatedTaxText: "General guidelines",
    extensionText: "Accepts extension forms",
    pteText: "Yes – if allowed by law",
    onlinePayProcess: "Use myVTax",
    additionalComments: "No special notes"
  },
  "Virginia": {
    extensionFormIndividual: "Form 760IP",
    extensionFormBusiness: "Form 502",
    estimateFormIndividual: "Form 760ES",
    estimateFormBusiness: "Form 502",
    pteForm: "Form 502",
    paymentUrlIndividual: "https://www.tax.virginia.gov/online-services",
    paymentUrlBusiness: "https://www.tax.virginia.gov/online-services",
    taxAgencyName: "Virginia Department of Taxation",
    estimatedTaxText: "Separate forms for individuals vs. businesses",
    extensionText: "760IP for individuals, 502 for businesses",
    pteText: "Yes – 502 used for PTE",
    onlinePayProcess: "Use VATAX online",
    additionalComments: "Business extension, estimates, PTE all on 502"
  },
  "Washington": {
    extensionFormIndividual: "Form WA-EXT-I",
    extensionFormBusiness: "Form WA-EXT-B",
    estimateFormIndividual: "Form WA-ES-I",
    estimateFormBusiness: "Form WA-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://dor.wa.gov/file-pay-taxes",
    paymentUrlBusiness: "https://dor.wa.gov/file-pay-taxes",
    taxAgencyName: "Washington Department of Revenue",
    estimatedTaxText: "WA has no personal income tax, only certain excise taxes",
    extensionText: "Not relevant for personal tax",
    pteText: "If B&O or capital gains?",
    onlinePayProcess: "Use WA DOR eFile",
    additionalComments: "Generally no personal tax"
  },
  "West Virginia": {
    extensionFormIndividual: "Form WV-EXT-I",
    extensionFormBusiness: "Form WV-EXT-B",
    estimateFormIndividual: "Form WV-ES-I",
    estimateFormBusiness: "Form WV-ES-B",
    pteForm: "Form WV-PTE",
    paymentUrlIndividual: "https://mytaxes.wvtax.gov",
    paymentUrlBusiness: "https://mytaxes.wvtax.gov",
    taxAgencyName: "West Virginia State Tax Department",
    estimatedTaxText: "Standard guidelines",
    extensionText: "Use WV-EXT forms if needed",
    pteText: "Yes – WV-PTE as needed",
    onlinePayProcess: "Use MyTaxes WV",
    additionalComments: "No special notes"
  },
  "Wisconsin": {
    extensionFormIndividual: "Form WI-EXT-I",
    extensionFormBusiness: "Form WI-EXT-B",
    estimateFormIndividual: "Form WI-ES-I",
    estimateFormBusiness: "Form WI-ES-B",
    pteForm: "Form WI-PTE",
    paymentUrlIndividual: "https://tap.revenue.wi.gov",
    paymentUrlBusiness: "https://tap.revenue.wi.gov",
    taxAgencyName: "Wisconsin Department of Revenue",
    estimatedTaxText: "Follows general procedures",
    extensionText: "Accepts fed extension or WI-EXT",
    pteText: "Yes – WI PTE or SALT workaround",
    onlinePayProcess: "Use WI TAP",
    additionalComments: "No special notes"
  },
  "Wyoming": {
    extensionFormIndividual: "Form WY-EXT-I",
    extensionFormBusiness: "Form WY-EXT-B",
    estimateFormIndividual: "Form WY-ES-I",
    estimateFormBusiness: "Form WY-ES-B",
    pteForm: "N/A",
    paymentUrlIndividual: "https://revenue.wyo.gov/online-services",
    paymentUrlBusiness: "https://revenue.wyo.gov/online-services",
    taxAgencyName: "Wyoming Department of Revenue",
    estimatedTaxText: "No personal income tax",
    extensionText: "No personal extension needed",
    pteText: "No – no personal income tax",
    onlinePayProcess: "Use WY DOR online services",
    additionalComments: "No individual income tax"
  }
};

/* ****************************************************************************
 * STATE-SPECIFIC LOGIC HOOKS
 *--------------------------------------------------------------------------*/
const stateLogic = {
  California: {
    getPaymentTypeMap(fd) {
      if (fd.entityType !== 'business') return null;
      switch (fd.businessType) {
        case 'ccorp':
        case 'scorp':
          return statesData['California'].corpScorpPaymentTypes;
        case 'llc':
          return statesData['California'].llcPaymentTypes;
        case 'partnership':
          return statesData['California'].partnershipPaymentTypes;
        default:
          return null;
      }
    }
  }
};

function getStatePaymentTypeMap(stateName, data = formData) {
  return stateLogic[stateName]?.getPaymentTypeMap(data) || null;
}



/******************************************************************************
 * 2) GLOBAL FORM DATA
 *****************************************************************************/
let formData = {
  addresseeName: '',
  paymentDueDate: '',
  senderName: '',
  showDueDateReminder: true,
  federalPayments: [],
  statePayments: [],
  entityType: 'individual',
  businessType: '',
  entityId: '',
  entityName: '',
  caCorpForm: '',
  // NEW: Toggles the disclaimers in the final email
  showDisclaimers: true
};

// { version, id, name, createdAt, updatedAt, clients: [{ clientId, data }] }
let session = null;
let activeClientId = null;
let currentBatchId = null;
let saveTimer = null;
let saveInFlight = false;
let pendingSave = false;
let portalUrlsByClientId = {};

/** Map two-letter abbreviations to full state names used in statesData */
const STATE_ABBREVIATIONS = {
  AL: 'Alabama',
  AK: 'Alaska',
  AZ: 'Arizona',
  AR: 'Arkansas',
  CA: 'California',
  CO: 'Colorado',
  CT: 'Connecticut',
  DE: 'Delaware',
  FL: 'Florida',
  GA: 'Georgia',
  HI: 'Hawaii',
  ID: 'Idaho',
  IL: 'Illinois',
  IN: 'Indiana',
  IA: 'Iowa',
  KS: 'Kansas',
  KY: 'Kentucky',
  LA: 'Louisiana',
  ME: 'Maine',
  MD: 'Maryland',
  MA: 'Massachusetts',
  MI: 'Michigan',
  MN: 'Minnesota',
  MS: 'Mississippi',
  MO: 'Missouri',
  MT: 'Montana',
  NE: 'Nebraska',
  NV: 'Nevada',
  NH: 'New Hampshire',
  NJ: 'New Jersey',
  NM: 'New Mexico',
  NY: 'New York',
  NC: 'North Carolina',
  ND: 'North Dakota',
  OH: 'Ohio',
  OK: 'Oklahoma',
  OR: 'Oregon',
  PA: 'Pennsylvania',
  RI: 'Rhode Island',
  SC: 'South Carolina',
  SD: 'South Dakota',
  TN: 'Tennessee',
  TX: 'Texas',
  UT: 'Utah',
  VT: 'Vermont',
  VA: 'Virginia',
  WA: 'Washington',
  WV: 'West Virginia',
  WI: 'Wisconsin',
  WY: 'Wyoming'
};

let generatedEmailHTML = '';
let previewManuallyEdited = false;

function escapeHTML(value) {
  const s = String(value ?? '');
  return s
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function plainTextToHtml(value) {
  return escapeHTML(value).replace(/\r?\n/g, '<br/>');
}

function safeUrl(url) {
  const s = String(url ?? '').trim();
  if (!s) return '';
  if (/^https?:\/\//i.test(s)) return s;
  return '';
}

function sanitizeHeaderValue(value) {
  return String(value ?? '').replace(/[\r\n]+/g, ' ').trim();
}

function sanitizeEmailHtmlForEml(html) {
  const raw = String(html ?? '');
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(raw, 'text/html');

    const removeTags = ['script', 'iframe', 'object', 'embed'];
    removeTags.forEach(tag => doc.querySelectorAll(tag).forEach(n => n.remove()));

    doc.querySelectorAll('*').forEach(el => {
      [...el.attributes].forEach(attr => {
        const name = attr.name.toLowerCase();
        const val = String(attr.value || '').trim();
        if (name.startsWith('on')) {
          el.removeAttribute(attr.name);
          return;
        }
        if ((name === 'href' || name === 'src') && /^javascript:/i.test(val)) {
          el.removeAttribute(attr.name);
        }
      });
    });

    return doc.body ? doc.body.innerHTML : raw;
  } catch {
    return raw;
  }
}

function isFutureDateISO(isoDateString) {
  if (!isoDateString) return false;
  const d = new Date(`${isoDateString}T00:00:00`);
  if (isNaN(d.getTime())) return false;

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return d.getTime() > today.getTime();
}

function attachAutoPreviewListeners() {
  const ids = [
    'entityId',
    'entityName'
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const evt = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
    el.addEventListener(evt, () => onFieldChange());
  });

  const previewArea = document.getElementById('previewArea');
  if (previewArea) {
    previewArea.addEventListener('input', () => {
      if (previewArea.getAttribute('contenteditable') === 'true') {
        previewManuallyEdited = true;
      }
    });
  }
}

/******************************************************************************
 * 3) WIZARD NAVIGATION & VALIDATION
 *****************************************************************************/
function validateField(field) {
  const errorDiv = field.parentElement ? field.parentElement.querySelector('.error-message') : null;
  let isValid = true;
  let errorMessage = '';

  const rawValue = field.value ?? '';
  const value = typeof rawValue === 'string' ? rawValue.trim() : String(rawValue).trim();

  if (field.required && !value) {
    isValid = false;
    errorMessage = 'This field is required';
  }

  if (isValid && field.id === 'paymentDueDate') {
    if (!isFutureDateISO(field.value)) {
      isValid = false;
      errorMessage = 'Pay-by date must be a future date';
    }
  }

  if (field.parentElement) {
    field.parentElement.classList.toggle('error', !isValid);
  }
  if (errorDiv) {
    errorDiv.textContent = errorMessage;
  }
  return isValid;
}

function validateStep(stepNumber) {
  const step = document.getElementById(`step-${stepNumber}`);
  if (!step) return true;
  
  const fields = step.querySelectorAll('input[required], select[required]');
  let isValid = true;

  fields.forEach(field => {
    // skip business-only fields if not a business
    if (
      field.closest('#businessFields') &&
      document.getElementById('entityType').value !== 'business'
    ) {
      return;
    }
    if (!validateField(field)) {
      isValid = false;
    }
  });
  return isValid;
}

function setSaveIndicator(text, state = 'idle') {
  const el = document.getElementById('saveStatus');
  if (!el) return;
  el.textContent = text;
  el.setAttribute('data-state', state);
}

function normalizeSessionData(raw) {
  let data = raw;
  if (!data || typeof data !== 'object') {
    data = null;
  }

  if (!data) {
    data = {
      version: 1,
      id: (crypto?.randomUUID?.() || `sess_${Date.now()}`),
      name: 'Untitled Session',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      clients: []
    };
  }

  if (!Array.isArray(data.clients)) data.clients = [];
  data.clients = data.clients
    .map(c => ({
      clientId: String(c?.clientId || '').trim(),
      data: normalizeFormDataLike(c?.data)
    }))
    .filter(c => c.clientId);

  return data;
}

async function ensureAuthenticated() {
  const resp = await fetch('/api/me');
  if (resp.status === 401) {
    window.location.href = '/login?next=/wizard';
    return false;
  }
  return resp.ok;
}

async function loadSessionFromServer() {
  setSaveIndicator('Loading...', 'saving');
  const resp = await fetch('/api/batches/current');
  if (resp.status === 401) {
    window.location.href = '/login?next=/wizard';
    return;
  }
  const data = await resp.json().catch(() => ({}));
  currentBatchId = data?.batchId || null;
  session = normalizeSessionData(data?.snapshot);
  portalUrlsByClientId = {};

  const nameInput = document.getElementById('sessionNameInput');
  if (nameInput) {
    nameInput.value = session.name || '';
  }
  setSaveIndicator('Saved', 'idle');
}

async function persistSessionToServer() {
  if (!session) return;
  if (saveInFlight) {
    pendingSave = true;
    return;
  }
  saveInFlight = true;
  setSaveIndicator('Saving...', 'saving');

  try {
    const resp = await fetch('/api/batches/current', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        batchId: currentBatchId,
        snapshot: session
      })
    });
    if (!resp.ok) {
      throw new Error(`Save failed (${resp.status})`);
    }
    const data = await resp.json().catch(() => ({}));
    if (data?.batchId) currentBatchId = data.batchId;
    setSaveIndicator('Saved', 'idle');
  } catch (e) {
    console.error(e);
    setSaveIndicator('Save error', 'error');
  } finally {
    saveInFlight = false;
    if (pendingSave) {
      pendingSave = false;
      queueAutosave();
    }
  }
}

function queueAutosave() {
  if (!session) return;
  setSaveIndicator('Saving...', 'saving');
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    persistSessionToServer();
  }, 1200);
}

function saveSessionToStorage() {
  if (!session) return;
  session.name = (document.getElementById('sessionNameInput')?.value || '').trim() || 'Untitled Session';
  session.updatedAt = new Date().toISOString();
  queueAutosave();
}

function waitForSaveCompletion() {
  return new Promise(resolve => {
    const timer = setInterval(() => {
      if (!saveInFlight && !pendingSave) {
        clearInterval(timer);
        resolve();
      }
    }, 100);
  });
}

async function ensureSavedNow() {
  if (!session) return;
  if (activeClientId) upsertActiveClientFromForm();
  if (saveInFlight) {
    await waitForSaveCompletion();
    return;
  }
  await persistSessionToServer();
  await waitForSaveCompletion();
}

async function newSession() {
  if (!confirm('Start a new session? This will replace the current session in the browser (you can Save JSON first).')) return;
  clearAssistantConversation();
  setSaveIndicator('Creating...', 'saving');
  try {
    const resp = await fetch('/api/batches', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    if (!resp.ok) {
      throw new Error(`Create failed (${resp.status})`);
    }
    const data = await resp.json().catch(() => ({}));
    currentBatchId = data?.batchId || null;
    session = normalizeSessionData(data?.snapshot);
    portalUrlsByClientId = {};
    session.clients = [];
    activeClientId = null;
    createNewClient();
    setSaveIndicator('Saved', 'idle');
  } catch (e) {
    console.error(e);
    setSaveIndicator('Save error', 'error');
  }
}

function snapshotFormData() {
  return JSON.parse(JSON.stringify(formData));
}

function normalizeFormDataLike(data) {
  const base = getInitialFormData();
  const merged = { ...base, ...(data || {}) };

  if (!Array.isArray(merged.federalPayments)) merged.federalPayments = [];
  if (!Array.isArray(merged.statePayments)) merged.statePayments = [];

  merged.statePayments = (merged.statePayments || [])
    .map(st => ({
      stateName: String(st?.stateName || '').trim(),
      payments: Array.isArray(st?.payments) ? st.payments : []
    }))
    .filter(st => st.stateName);

  return merged;
}

function generateClientId() {
  const clients = session?.clients || [];
  const existing = new Set(clients.map(c => String(c.clientId)));
  let n = clients.length + 1;
  while (existing.has(`client-${String(n).padStart(3, '0')}`)) n++;
  return `client-${String(n).padStart(3, '0')}`;
}

function upsertActiveClientFromForm() {
  if (!session) return;

  if (!activeClientId) {
    if (session.clients.length) {
      activeClientId = session.clients[0].clientId;
    } else {
      const id = generateClientId();
      session.clients.push({ clientId: id, data: snapshotFormData() });
      activeClientId = id;
      saveSessionToStorage();
      return;
    }
  }

  const idx = session.clients.findIndex(c => c.clientId === activeClientId);
  if (idx >= 0) {
    session.clients[idx].data = snapshotFormData();
  } else {
    session.clients.push({ clientId: activeClientId, data: snapshotFormData() });
  }
  saveSessionToStorage();
}

function createNewClient() {
  if (!session) return;
  if (activeClientId) upsertActiveClientFromForm();

  const id = generateClientId();
  const blank = getInitialFormData();
  session.clients.push({ clientId: id, data: blank });
  activeClientId = id;

  saveSessionToStorage();
  loadFormDataIntoUI(blank);
  renderSessionUI();
}

function duplicateActiveClient() {
  if (!session) return;
  if (!activeClientId) {
    createNewClient();
    return;
  }

  upsertActiveClientFromForm();
  const current = session.clients.find(c => c.clientId === activeClientId);
  if (!current) return;

  const id = generateClientId();
  const copy = current.data ? JSON.parse(JSON.stringify(current.data)) : getInitialFormData();
  session.clients.push({ clientId: id, data: copy });
  activeClientId = id;

  saveSessionToStorage();
  loadFormDataIntoUI(copy);
  renderSessionUI();
}

function deleteActiveClient() {
  if (!session || !activeClientId) return;

  const active = session.clients.find(c => c.clientId === activeClientId);
  const label = active?.data?.addresseeName ? ` (${active.data.addresseeName})` : '';
  if (!confirm(`Delete client ${activeClientId}${label}? This cannot be undone.`)) return;

  const idx = session.clients.findIndex(c => c.clientId === activeClientId);
  if (idx < 0) return;

  session.clients.splice(idx, 1);

  if (!session.clients.length) {
    activeClientId = null;
    saveSessionToStorage();
    createNewClient();
    return;
  }

  const next = session.clients[Math.min(idx, session.clients.length - 1)];
  activeClientId = next.clientId;

  saveSessionToStorage();
  loadFormDataIntoUI(next.data);
  renderSessionUI();
}

function selectClient(clientId) {
  if (!session) return;
  if (!clientId) return;

  if (activeClientId) upsertActiveClientFromForm();

  const c = session.clients.find(x => x.clientId === clientId);
  if (!c) return;

  activeClientId = clientId;
  saveSessionToStorage();
  loadFormDataIntoUI(c.data);
  renderSessionUI();
}

function selectClientFromDropdown() {
  const sel = document.getElementById('clientSelector');
  if (!sel) return;
  selectClient(sel.value);
}

function selectClientByIndex(index) {
  const c = session?.clients?.[index];
  if (!c) return;
  selectClient(c.clientId);
}

function previewSessionClient(index) {
  selectClientByIndex(index);
}

function editSessionClient(index) {
  selectClientByIndex(index);
  document.getElementById('addresseeName')?.focus();
}

function renderSessionUI() {
  renderClientSelector();
  renderClientsTable();
}

function renderClientSelector() {
  const sel = document.getElementById('clientSelector');
  if (!sel) return;

  sel.innerHTML = '';
  const clients = session?.clients || [];
  if (!clients.length) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No clients yet';
    sel.appendChild(opt);
    sel.disabled = true;
    return;
  }

  sel.disabled = false;
  clients.forEach(c => {
    const d = c.data || {};
    const opt = document.createElement('option');
    opt.value = c.clientId;
    opt.textContent = `${c.clientId} — ${d.addresseeName || '(Unnamed)'}`;
    if (c.clientId === activeClientId) opt.selected = true;
    sel.appendChild(opt);
  });
}

function renderClientsTable() {
  const el = document.getElementById('sessionClientsTable');
  if (!el) return;

  const clients = session?.clients || [];
  if (!clients.length) {
    el.innerHTML = '<p>No clients yet.</p>';
    return;
  }

  let html = `<table><tr>
    <th>Client ID</th><th>Client</th><th>Federal</th><th>State</th><th>Actions</th>
  </tr>`;

  clients.forEach((c, idx) => {
    const d = c.data || {};
    const fed = (d.federalPayments || []).length;
    const st = (d.statePayments || []).reduce((sum, s) => sum + (s.payments || []).length, 0);

    html += `<tr>
      <td>${escapeHTML(c.clientId)}</td>
      <td>${escapeHTML(d.addresseeName || '(Unnamed)')}</td>
      <td>${fed}</td>
      <td>${st}</td>
      <td style="white-space:nowrap;">
        <button type="button" onclick="previewSessionClient(${idx})">Preview</button>
        <button type="button" onclick="editSessionClient(${idx})">Edit</button>
      </td>
    </tr>`;
  });

  html += `</table>`;
  el.innerHTML = html;
}

function sanitizeFilename(value) {
  return String(value || '')
    .replace(/[^a-z0-9\\-]+/gi, '_')
    .replace(/_+/g, '_')
    .replace(/^_+|_+$/g, '') || 'session';
}

function triggerImportCsv() {
  document.getElementById('importCsvInput')?.click();
}

function triggerLoadSessionJson() {
  document.getElementById('importJsonInput')?.click();
}

function applyImportedJobsToSession(jobs) {
  if (!session) return;

  session.clients = (jobs || []).map(j => ({
    clientId: String(j.clientId || '').trim(),
    data: normalizeFormDataLike(j.data)
  })).filter(j => j.clientId);

  activeClientId = session.clients[0]?.clientId || null;
  saveSessionToStorage();

  if (activeClientId) {
    loadFormDataIntoUI(session.clients[0].data);
  } else {
    loadFormDataIntoUI(getInitialFormData());
  }
  renderSessionUI();
}

function importCsvFile(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;

  const input = event.target;
  input.value = '';

  if (!session) return;

  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) loadingIndicator.classList.add('active');

  const name = (file.name || '').toLowerCase();

  const onDone = () => {
    if (loadingIndicator) loadingIndicator.classList.remove('active');
  };

  const applyRows = (rows) => {
    const jobs = groupRowsIntoJobs(rows || []);
    if (!jobs.length) {
      alert('No clients found in the file (missing or empty ClientId).');
      return;
    }
    if (!confirm(`Import ${jobs.length} client(s)? This will replace the current session clients.`)) {
      return;
    }
    applyImportedJobsToSession(jobs);
  };

  if (name.endsWith('.csv')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const text = e.target.result || '';
        const rows = parseCsvToObjects(text);
        applyRows(rows);
      } finally {
        onDone();
      }
    };
    reader.onerror = function() {
      onDone();
      alert('Could not read CSV file.');
    };
    reader.readAsText(file);
  } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
    if (typeof XLSX === 'undefined') {
      onDone();
      alert('Excel parsing library not loaded. Please upload a CSV file instead.');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        applyRows(rows);
      } finally {
        onDone();
      }
    };
    reader.onerror = function() {
      onDone();
      alert('Could not read Excel file.');
    };
    reader.readAsArrayBuffer(file);
  } else {
    onDone();
    alert('Unsupported file type. Please upload a .csv or .xlsx file.');
  }
}

function exportSessionCsv() {
  if (!session) return;

  upsertActiveClientFromForm();

  const headers = [
    'ClientId',
    'ClientName',
    'SenderName',
    'PayByDate',
    'EntityType',
    'BusinessType',
    'EntityName',
    'EntityId',
    'CaCorpForm',
    'PaymentScope',
    'State',
    'PaymentType',
    'Method',
    'Quarter',
    'TaxYear',
    'DueDate',
    'Amount',
    'Notes'
  ];

  const csvEscape = (val) => {
    const s = String(val ?? '');
    if (/[",\r\n]/.test(s)) return `"${s.replace(/\"/g, '""')}"`;
    return s;
  };

  const normalizeDateForCsv = (val) => {
    const s = String(val ?? '').trim();
    if (!s) return '';
    const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (iso) return `${iso[2]}/${iso[3]}/${iso[1]}`;
    const mdy = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
    if (mdy) return `${mdy[1]}/${mdy[2]}/${mdy[3]}`;
    return s;
  };

  const lines = [headers.join(',')];

  (session.clients || []).forEach(c => {
    const d = c.data || {};
    const base = {
      ClientId: c.clientId || '',
      ClientName: d.addresseeName || '',
      SenderName: d.senderName || '',
      PayByDate: normalizeDateForCsv(d.paymentDueDate),
      EntityType: d.entityType || '',
      BusinessType: d.businessType || '',
      EntityName: d.entityName || '',
      EntityId: d.entityId || '',
      CaCorpForm: d.caCorpForm || ''
    };

    const rows = [];

    (d.federalPayments || []).forEach(p => {
      rows.push({
        ...base,
        PaymentScope: 'federal',
        State: '',
        PaymentType: p.type || '',
        Method: p.method || '',
        Quarter: p.quarter || '',
        TaxYear: p.taxPeriod || '',
        DueDate: normalizeDateForCsv(p.dueDate),
        Amount: p.amount || '',
        Notes: p.description || ''
      });
    });

    (d.statePayments || []).forEach(st => {
      (st.payments || []).forEach(p => {
        rows.push({
          ...base,
          PaymentScope: 'state',
          State: st.stateName || '',
          PaymentType: p.type || '',
          Method: p.method || '',
          Quarter: p.quarter || '',
          TaxYear: p.taxPeriod || '',
          DueDate: normalizeDateForCsv(p.dueDate),
          Amount: p.amount || '',
          Notes: p.description || ''
        });
      });
    });

    if (!rows.length) {
      rows.push({
        ...base,
        PaymentScope: '',
        State: '',
        PaymentType: '',
        Method: '',
        Quarter: '',
        TaxYear: '',
        DueDate: '',
        Amount: '',
        Notes: ''
      });
    }

    rows.forEach(r => {
      const line = headers.map(h => csvEscape(r[h] ?? '')).join(',');
      lines.push(line);
    });
  });

  const csv = lines.join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${sanitizeFilename(session.name)}.csv`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

function saveSessionJson() {
  if (!session) return;

  upsertActiveClientFromForm();
  saveSessionToStorage();

  const json = JSON.stringify(session, null, 2);
  const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${sanitizeFilename(session.name)}.json`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

function importSessionJsonFile(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;

  const input = event.target;
  input.value = '';

  const reader = new FileReader();
  reader.onload = function(e) {
    const raw = e.target.result || '';
    let parsed = null;
    try {
      parsed = JSON.parse(String(raw));
    } catch {
      alert('Invalid JSON file.');
      return;
    }
    if (!parsed || typeof parsed !== 'object' || !Array.isArray(parsed.clients)) {
      alert('JSON does not look like a session file.');
      return;
    }

    session = parsed;
    if (!session.version) session.version = 1;
    if (!session.id) session.id = (crypto?.randomUUID?.() || `sess_${Date.now()}`);
    if (!session.createdAt) session.createdAt = new Date().toISOString();
    session.updatedAt = new Date().toISOString();
    if (!Array.isArray(session.clients)) session.clients = [];
    session.clients = session.clients
      .map(c => ({
        clientId: String(c?.clientId || '').trim(),
        data: normalizeFormDataLike(c?.data)
      }))
      .filter(c => c.clientId);

    const nameInput = document.getElementById('sessionNameInput');
    if (nameInput) nameInput.value = session.name || '';

    activeClientId = session.clients[0]?.clientId || null;
    saveSessionToStorage();

    if (activeClientId) {
      loadFormDataIntoUI(session.clients[0].data);
    } else {
      createNewClient();
    }
    renderSessionUI();
  };
  reader.onerror = function() {
    alert('Could not read JSON file.');
  };
  reader.readAsText(file);
}

function generateSessionDrafts() {
  if (!session) return;

  upsertActiveClientFromForm();

  if (!session.clients?.length) {
    alert('No clients in this session.');
    return;
  }

  if (typeof JSZip === 'undefined') {
    alert('Zip library not loaded. Please check your internet connection and try again.');
    return;
  }

  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) loadingIndicator.classList.add('active');

  const zip = new JSZip();

  session.clients.forEach(job => {
    const data = job.data || {};
    const html = buildEmailHTMLFromData(data, {
      includeDisclaimers: data.showDisclaimers ?? true,
      includePreviewHeader: false,
      portalUrl: portalUrlsByClientId[job.clientId] || ''
    });
    const subjectDate = formatDueDateForSubject(data.paymentDueDate);
    const subject = `Tax Payment Instructions - Due ${subjectDate || ''}`;

    let filenameBase = (data.addresseeName || job.clientId || 'Client')
      .replace(/[^a-z0-9\\-]+/gi, '_')
      .replace(/_+/g, '_')
      .replace(/^_+|_+$/g, '');
    if (!filenameBase) filenameBase = 'Client';

    const emlContent = buildEmlContent({
      subject,
      from: '',
      to: '',
      htmlBody: html
    });

    zip.file(`${filenameBase}.eml`, emlContent);
  });

  zip.generateAsync({ type: 'blob' })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${sanitizeFilename(session.name)}_DraftEmails.zip`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(err => {
      console.error(err);
      alert('There was an error generating the ZIP file.');
    })
    .finally(() => {
      if (loadingIndicator) loadingIndicator.classList.remove('active');
    });
}

async function generateChecklistLink() {
  if (!session || !activeClientId) {
    alert('Select a client first.');
    return;
  }

  try {
    await ensureSavedNow();
    if (!currentBatchId) {
      throw new Error('Missing batch');
    }

    const resp = await fetch('/api/plans/publish', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        batchId: currentBatchId,
        wizardClientId: activeClientId
      })
    });

    if (!resp.ok) {
      throw new Error(`Publish failed (${resp.status})`);
    }

    const data = await resp.json().catch(() => ({}));
    if (!data?.portalUrl) {
      throw new Error('Missing portal URL');
    }

    portalUrlsByClientId[activeClientId] = data.portalUrl;
    regeneratePreviewHTML();
    alert(`Checklist link generated:\n${data.portalUrl}`);
  } catch (e) {
    console.error(e);
    alert('Unable to generate checklist link. Please try again.');
  }
}

function syncSessionAfterChange(options = {}) {
  if (!session) return;
  upsertActiveClientFromForm();
  if (options.render !== false) {
    renderSessionUI();
  }
}

// =========================
// AI ASSISTANT (front-end)
// =========================
let assistantRequestInFlight = false;
let assistantThread = []; // [{ role: 'user'|'assistant', text: string }]

function setAssistantStatus(text) {
  const el = document.getElementById('assistantStatus');
  if (el) el.textContent = text || '';
}

function clearAssistantConversation() {
  assistantThread = [];
  setAssistantStatus('');
  const box = document.getElementById('assistantMessages');
  if (box) box.innerHTML = '';
}

function setAssistantBusy(isBusy) {
  assistantRequestInFlight = !!isBusy;
  const btn = document.getElementById('assistantSendBtn');
  if (btn) btn.disabled = assistantRequestInFlight;
  const input = document.getElementById('assistantInput');
  if (input) input.disabled = assistantRequestInFlight;
}

function appendAssistantMessage(role, text) {
  assistantThread.push({ role, text: String(text ?? '') });
  if (assistantThread.length > 20) assistantThread = assistantThread.slice(-20);

  const box = document.getElementById('assistantMessages');
  if (!box) return;

  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.justifyContent = (role === 'user') ? 'flex-end' : 'flex-start';
  row.style.margin = '8px 0';

  const bubble = document.createElement('div');
  bubble.style.maxWidth = '85%';
  bubble.style.padding = '10px 12px';
  bubble.style.borderRadius = '12px';
  bubble.style.whiteSpace = 'pre-wrap';
  bubble.style.border = '1px solid #e2e8f0';
  bubble.style.background = (role === 'user') ? '#eef6ff' : '#f8fafc';
  bubble.style.color = '#111827';
  bubble.textContent = String(text ?? '');

  row.appendChild(bubble);
  box.appendChild(row);
  box.scrollTop = box.scrollHeight;
}

function slugifyClientId(name) {
  return String(name || '')
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function uniqueClientId(base) {
  const existing = new Set((session?.clients || []).map(c => String(c.clientId)));
  const clean = String(base || '').trim();
  if (!clean) return generateClientId();
  if (!existing.has(clean)) return clean;
  let i = 2;
  while (existing.has(`${clean}-${i}`)) i++;
  return `${clean}-${i}`;
}

function findClientIdByName(name) {
  const n = String(name || '').trim().toLowerCase();
  if (!n) return null;
  const hit = (session?.clients || []).find(
    c => String(c.data?.addresseeName || '').trim().toLowerCase() === n
  );
  return hit?.clientId || null;
}

function createClientWithId(clientId, initialData) {
  if (!session) return null;
  if (activeClientId) upsertActiveClientFromForm();

  const id = uniqueClientId(String(clientId || '').trim() || generateClientId());
  const data = normalizeFormDataLike(initialData || getInitialFormData());

  session.clients.push({ clientId: id, data });
  activeClientId = id;

  saveSessionToStorage();
  loadFormDataIntoUI(data);
  renderSessionUI();
  return id;
}

function normalizeAnyDateToMMDDYYYY(value) {
  return normalizeDateToMMDDYYYY(value);
}

function mapCaIndividualPaymentType(rawType) {
  const t = String(rawType || '').toLowerCase();
  if (t.includes('estimated')) return 'Estimated Tax Payment (Form 540-ES)';
  if (t.includes('extension')) return 'Extension Payment (Form 3519)';
  if (t.includes('balance') || t.includes('return')) return 'Tax Return Payment';
  return String(rawType || '');
}

function mapCaBusinessPaymentType(rawType, data) {
  const paymentTypeMap = getStatePaymentTypeMap('California', data);
  const tRaw = String(rawType || '').trim();
  if (!tRaw) return '';
  if (!paymentTypeMap) return normalizeGenericPaymentType(tRaw);
  if (paymentTypeMap[tRaw]) return tRaw;

  const lower = tRaw.toLowerCase();
  const keys = Object.keys(paymentTypeMap);

  // Match by label exact
  for (const k of keys) {
    const lbl = String(paymentTypeMap[k]?.label || '').trim().toLowerCase();
    if (lbl && lbl === lower) return k;
  }

  const findByLabelIncludes = (needle) =>
    keys.find(k => String(paymentTypeMap[k]?.label || '').toLowerCase().includes(needle));

  if (lower.includes('pte') || lower.includes('pass-through')) return paymentTypeMap.pte ? 'pte' : (findByLabelIncludes('pass-through') || tRaw);
  if (lower.includes('estimated')) return findByLabelIncludes('estimated') || tRaw;
  if (lower.includes('extension')) return findByLabelIncludes('extension') || tRaw;
  if (lower.includes('annual')) return findByLabelIncludes('annual') || tRaw;
  if (lower.includes('bill')) return findByLabelIncludes('bill') || tRaw;
  if (lower.includes('amend')) return findByLabelIncludes('amended') || tRaw;
  if (lower.includes('audit')) return findByLabelIncludes('audit') || tRaw;
  if (lower.includes('notice') || lower.includes('npa') || lower.includes('proposed assessment')) {
    return findByLabelIncludes('notice') || findByLabelIncludes('assessment') || tRaw;
  }

  return tRaw;
}

function normalizeGenericPaymentType(rawType) {
  const t = String(rawType || '').toLowerCase();
  if (t.includes('estimated')) return 'Estimated';
  if (t.includes('extension')) return 'Extension';
  if (t.includes('balance') || t.includes('return')) return 'Balance Due';
  if (t.includes('pte')) return 'PTE';
  return String(rawType || '');
}

function inferTaxYearForEstimatedQ4(dueMdy) {
  const m = String(dueMdy || '').match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if (!m) return null;
  const month = Number(m[1]);
  const year = Number(m[3]);
  if (!Number.isFinite(month) || !Number.isFinite(year)) return null;
  // If Q4 estimate due in January, tax year is typically the prior year.
  if (month === 1) return String(year - 1);
  return null;
}

function applyAssistantPlan(plan) {
  if (!plan || typeof plan !== 'object') return;
  const actions = Array.isArray(plan.actions) ? plan.actions : [];

  if (previewManuallyEdited) {
    const ok = confirm('Applying AI actions will overwrite unsaved preview edits. Continue?');
    if (!ok) return;
  }

  // 1) Handle create/select first (so subsequent actions apply to the right client)
  for (const a of actions) {
    if (!a || typeof a !== 'object') continue;

    if (a.type === 'create_client') {
      const desiredName = a.client_name || '';
      const baseId = a.client_id || slugifyClientId(desiredName) || '';
      const id = baseId ? uniqueClientId(baseId) : generateClientId();

      const blank = getInitialFormData();
      if (desiredName) blank.addresseeName = String(desiredName);
      createClientWithId(id, blank);
    }

    if (a.type === 'select_client') {
      const id = a.client_id || findClientIdByName(a.client_name);
      if (id) selectClient(id);
    }
  }

  // 2) Apply basic info (before payments so entityType/businessType are set)
  for (const a of actions) {
    if (!a || typeof a !== 'object') continue;

    if (a.type === 'set_basic_info') {
      if (a.addressee_name != null) formData.addresseeName = String(a.addressee_name);
      if (a.sender_name != null) formData.senderName = String(a.sender_name);

      if (a.pay_by_date != null) {
        formData.paymentDueDate = normalizeAnyDateToMMDDYYYY(a.pay_by_date);
      }

      if (a.entity_type === 'individual' || a.entity_type === 'business') {
        formData.entityType = a.entity_type;
      }

      if (a.show_due_date_reminder != null) formData.showDueDateReminder = !!a.show_due_date_reminder;
      if (a.show_disclaimers != null) formData.showDisclaimers = !!a.show_disclaimers;

      if (formData.entityType === 'business') {
        if (a.business_type) formData.businessType = String(a.business_type);
        if (a.entity_name != null) formData.entityName = String(a.entity_name);
        if (a.entity_id != null) formData.entityId = String(a.entity_id);
        if (a.ca_corp_form != null) formData.caCorpForm = String(a.ca_corp_form);
      } else {
        formData.businessType = '';
        formData.entityName = '';
        formData.entityId = '';
        formData.caCorpForm = '';
      }
    }
  }

  // 3) Apply payments
  for (const a of actions) {
    if (!a || typeof a !== 'object') continue;

    if (a.type === 'add_federal_payment') {
      if (!Array.isArray(formData.federalPayments)) formData.federalPayments = [];

      const pType = normalizeGenericPaymentType(a.payment_type || 'Estimated');
      const due = normalizeAnyDateToMMDDYYYY(a.due_date);
      const quarter = a.quarter ? String(a.quarter).toUpperCase() : '';

      let taxYear = a.tax_year != null ? String(a.tax_year) : '';
      if (!taxYear && pType.toLowerCase().includes('estimated') && quarter === 'Q4') {
        taxYear = inferTaxYearForEstimatedQ4(due) || '';
      }
      if (!taxYear) {
        taxYear = inferTaxYearForPayment({
          paymentType: pType,
          quarter,
          dueDate: due,
          payByDate: formData.paymentDueDate
        });
      }

      const method = formData.entityType === 'business'
        ? recommendedBusinessFederalMethod(formData)
        : 'direct_pay';

      formData.federalPayments.push({
        type: pType,
        quarter: pType.toLowerCase().includes('estimated') ? quarter : '',
        dueDate: due,
        amount: a.amount != null ? String(a.amount) : '',
        description: a.notes != null ? String(a.notes) : '',
        taxPeriod: taxYear,
        method
      });
    }

    if (a.type === 'add_state_payment') {
      if (!Array.isArray(formData.statePayments)) formData.statePayments = [];

      const stateName = normalizeStateName(a.state) || String(a.state || '').trim();
      if (!stateName) continue;

      let st = formData.statePayments.find(x => x.stateName === stateName);
      if (!st) {
        st = { stateName, payments: [] };
        formData.statePayments.push(st);
      }
      if (!Array.isArray(st.payments)) st.payments = [];

      const due = normalizeAnyDateToMMDDYYYY(a.due_date);
      const quarter = a.quarter ? String(a.quarter).toUpperCase() : '';

      let paymentType = a.payment_type || 'Estimated';
      if (stateName === 'California' && formData.entityType === 'business') {
        paymentType = mapCaBusinessPaymentType(paymentType, formData);
      } else if (stateName === 'California') {
        paymentType = mapCaIndividualPaymentType(paymentType);
      } else {
        paymentType = normalizeGenericPaymentType(paymentType);
      }

      let taxYear = a.tax_year != null ? String(a.tax_year) : '';
      if (!taxYear && String(paymentType).toLowerCase().includes('estimated') && quarter === 'Q4') {
        taxYear = inferTaxYearForEstimatedQ4(due) || '';
      }
      if (!taxYear) {
        taxYear = inferTaxYearForPayment({
          paymentType,
          quarter,
          dueDate: due,
          payByDate: formData.paymentDueDate
        });
      }

      st.payments.push({
        type: String(paymentType),
        quarter: String(paymentType).toLowerCase().includes('estimated') ? quarter : '',
        dueDate: due,
        amount: a.amount != null ? String(a.amount) : '',
        description: a.notes != null ? String(a.notes) : '',
        taxPeriod: taxYear,
        method: (a.method === 'mail') ? 'mail' : 'electronic'
      });
    }
  }

  loadFormDataIntoUI(formData);
  syncSessionAfterChange();
}

async function assistantSend() {
  if (assistantRequestInFlight) return;

  const input = document.getElementById('assistantInput');
  const msg = String(input?.value || '').trim();
  if (!msg) return;

  input.value = '';
  appendAssistantMessage('user', msg);

  const payload = {
    message: msg,
    context: {
      sessionName: session?.name || '',
      clients: (session?.clients || []).map(c => ({
        clientId: c.clientId,
        clientName: c.data?.addresseeName || ''
      })),
      activeClientId: activeClientId || '',
      activeClient: snapshotFormData(),
      assistantThread
    }
  };

  try {
    setAssistantBusy(true);
    setAssistantStatus('Thinking…');

    const resp = await fetch('/api/assistant', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      let details = '';
      try {
        const t = await resp.text();
        details = t ? `\n\n${t.slice(0, 500)}` : '';
      } catch {}
      throw new Error(`Assistant API error (HTTP ${resp.status})${details}`);
    }
    const plan = await resp.json();

    if (plan?.assistant_message) {
      appendAssistantMessage('assistant', String(plan.assistant_message));
    } else {
      appendAssistantMessage('assistant', 'OK.');
    }

    applyAssistantPlan(plan);
    setAssistantStatus('');
  } catch (e) {
    console.error(e);
    setAssistantStatus('');
    appendAssistantMessage(
      'assistant',
      `AI request failed. Make sure \`/api/assistant\` is deployed and \`OPENAI_API_KEY\` is set in Vercel.\n\n${String(e?.message || e)}`
    );
  } finally {
    setAssistantBusy(false);
  }
}

function goToStep(stepNumber) {
  const currentStep = document.querySelector('.wizard-step.active');
  if (currentStep) {
    const currentStepNum = parseInt(currentStep.id.split('-')[1], 10);
    if (stepNumber > currentStepNum && !validateStep(currentStepNum)) {
      return;
    }
  }
  onFieldChange(); // Update form data before changing steps

  const steps = document.querySelectorAll('.step-progress li');
  steps.forEach((li, i) => {
    li.classList.remove('active', 'completed');
    if (i + 1 < stepNumber) {
      li.classList.add('completed');
    } else if (i + 1 === stepNumber) {
      li.classList.add('active');
    }
  });

  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(`step-${stepNumber}`);
  if (target) target.classList.add('active');

  regeneratePreviewHTML();
  if (stepNumber === 4) {
    updateReviewStep();
  }
}

/******************************************************************************
 * 4) FORM DATA & RENDERING
 *****************************************************************************/
function onFieldChange() {
  // Update basic fields
  formData.addresseeName = (document.getElementById('addresseeName')?.value || '').trim();
  formData.senderName = (document.getElementById('senderName')?.value || '').trim();
  formData.showDueDateReminder = document.getElementById('showDueDateReminder')?.checked ?? true;
  formData.showDisclaimers = document.getElementById('showDisclaimers')?.checked ?? true;

  const rawDate = document.getElementById('paymentDueDate')?.value;
  if (rawDate) {
    formData.paymentDueDate = formatDateToMMDDYYYY(rawDate);
  }

  // Update entity type
  const entityType = document.getElementById('entityType')?.value;
  formData.entityType = entityType;

  if (entityType === 'business') {
    formData.businessType = document.getElementById('businessType')?.value || '';
    formData.entityId = (document.getElementById('entityId')?.value || '').trim();
    formData.entityName = (document.getElementById('entityName')?.value || '').trim();
    formData.caCorpForm = document.getElementById('caCorpForm')?.value || '';
  } else {
    // clear out business data if user toggles back to individual
    formData.businessType = '';
    formData.entityName = '';
    formData.entityId = '';
    formData.caCorpForm = '';
  }

  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function defaultPayByDateISO() {
  const now = new Date();
  const year = now.getFullYear();

  const today = new Date(year, now.getMonth(), now.getDate());
  today.setHours(0, 0, 0, 0);

  const apr15ThisYear = new Date(year, 3, 15); // month is 0-based
  apr15ThisYear.setHours(0, 0, 0, 0);

  const targetYear = today.getTime() < apr15ThisYear.getTime() ? year : year + 1;
  const target = new Date(targetYear, 3, 15);

  const yyyy = target.getFullYear();
  const mm = String(target.getMonth() + 1).padStart(2, '0');
  const dd = String(target.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function defaultPayByDateMMDDYYYY() {
  return formatDateToMMDDYYYY(defaultPayByDateISO());
}

function parseAnyDateToLocalDate(value) {
  const iso = toISODateForInput(value);
  if (!iso) return null;

  const parts = iso.split('-');
  if (parts.length !== 3) return null;
  const yyyy = Number(parts[0]);
  const mm = Number(parts[1]);
  const dd = Number(parts[2]);
  if (!Number.isFinite(yyyy) || !Number.isFinite(mm) || !Number.isFinite(dd)) return null;

  const d = new Date(yyyy, mm - 1, dd);
  if (isNaN(d.getTime())) return null;
  d.setHours(0, 0, 0, 0);
  return d;
}

function findEarliestPaymentDueDate(data) {
  const dates = [];
  (data?.federalPayments || []).forEach(p => {
    const d = parseAnyDateToLocalDate(p?.dueDate);
    if (d) dates.push(d);
  });
  (data?.statePayments || []).forEach(st => {
    (st?.payments || []).forEach(p => {
      const d = parseAnyDateToLocalDate(p?.dueDate);
      if (d) dates.push(d);
    });
  });
  if (!dates.length) return null;

  let min = dates[0];
  for (let i = 1; i < dates.length; i++) {
    if (dates[i].getTime() < min.getTime()) min = dates[i];
  }
  return min;
}

function updatePayByDateWarning() {
  const el = document.getElementById('payByDateWarning');
  if (!el) return;

  const payByIso = document.getElementById('paymentDueDate')?.value || '';
  const payByDate = parseAnyDateToLocalDate(payByIso);
  const earliest = findEarliestPaymentDueDate(formData);

  if (!payByDate || !earliest) {
    el.textContent = '';
    el.style.display = 'none';
    return;
  }

  if (earliest.getTime() < payByDate.getTime()) {
    const earliestLabel = earliest.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
    el.textContent = `Warning: One or more payments are due before your chosen pay-by date (earliest due: ${earliestLabel}).`;
    el.style.display = 'block';
  } else {
    el.textContent = '';
    el.style.display = 'none';
  }
}

function inferTaxYearForPayment({ paymentType, quarter, dueDate, payByDate }) {
  const typeLower = String(paymentType || '').toLowerCase();
  const q = String(quarter || '').trim().toUpperCase();

  const due = parseAnyDateToLocalDate(dueDate);
  const payBy = parseAnyDateToLocalDate(payByDate);

  if (typeLower.includes('estimated')) {
    if (q === 'Q4' && due && due.getMonth() === 0) {
      return String(due.getFullYear() - 1);
    }
    if (due) return String(due.getFullYear());
    if (payBy) return String(payBy.getFullYear());
    return String(new Date().getFullYear());
  }

  const basis = due || payBy;
  if (!basis) return String(new Date().getFullYear());

  const year = basis.getFullYear();
  // Most return/extension payments in Jan–Apr are for the prior tax year.
  if (basis.getMonth() <= 3) return String(year - 1);
  return String(year);
}

// Helper for initial data
function getInitialFormData() {
  return {
    addresseeName: '',
    paymentDueDate: defaultPayByDateMMDDYYYY(),
    senderName: '',
    showDueDateReminder: true,
    federalPayments: [],
    statePayments: [],
    entityType: 'individual',
    businessType: '',
    entityId: '',
    entityName: '',
    caCorpForm: '',
    showDisclaimers: true
  };
}

function toISODateForInput(value) {
  const s = String(value ?? '').trim();
  if (!s) return '';

  // Already ISO
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // MM-DD-YYYY or MM/DD/YYYY
  const m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (m) return `${m[3]}-${m[1]}-${m[2]}`;

  // Fallback parse
  const parsed = new Date(s.replace(/-/g, '/'));
  if (isNaN(parsed.getTime())) return '';

  const yyyy = parsed.getFullYear();
  const mm = String(parsed.getMonth() + 1).padStart(2, '0');
  const dd = String(parsed.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function loadFormDataIntoUI(data) {
  const base = getInitialFormData();
  const clone = data ? JSON.parse(JSON.stringify(data)) : {};
  const merged = {
    ...base,
    ...clone,
    federalPayments: Array.isArray(clone.federalPayments) ? clone.federalPayments : [],
    statePayments: Array.isArray(clone.statePayments) ? clone.statePayments : []
  };

  merged.showDueDateReminder = merged.showDueDateReminder !== false;
  merged.showDisclaimers = merged.showDisclaimers !== false;

  Object.assign(formData, merged);

  // Clear visible validation errors when switching clients
  document.querySelectorAll('.form-field.error').forEach(el => {
    el.classList.remove('error');
    const msg = el.querySelector('.error-message');
    if (msg) msg.textContent = '';
  });

  const addresseeEl = document.getElementById('addresseeName');
  if (addresseeEl) addresseeEl.value = merged.addresseeName || '';

  const senderEl = document.getElementById('senderName');
  if (senderEl) senderEl.value = merged.senderName || '';

  const payByEl = document.getElementById('paymentDueDate');
  if (payByEl) payByEl.value = toISODateForInput(merged.paymentDueDate) || defaultPayByDateISO();

  const dueReminderEl = document.getElementById('showDueDateReminder');
  if (dueReminderEl) dueReminderEl.checked = merged.showDueDateReminder;

  const entityTypeEl = document.getElementById('entityType');
  if (entityTypeEl) entityTypeEl.value = merged.entityType || 'individual';

  const isBiz = (entityTypeEl?.value || merged.entityType) === 'business';
  const businessFields = document.getElementById('businessFields');
  if (businessFields) businessFields.classList.toggle('hidden', !isBiz);

  const businessTypeEl = document.getElementById('businessType');
  if (businessTypeEl) businessTypeEl.value = merged.businessType || 'ccorp';

  const entityIdEl = document.getElementById('entityId');
  if (entityIdEl) entityIdEl.value = merged.entityId || '';

  const entityNameEl = document.getElementById('entityName');
  if (entityNameEl) entityNameEl.value = merged.entityName || '';

  const caCorpFormEl = document.getElementById('caCorpForm');
  if (caCorpFormEl) caCorpFormEl.value = merged.caCorpForm || '';

  const caCorpFormField = document.getElementById('caCorpFormField');
  const bt = (businessTypeEl?.value || merged.businessType || '').toLowerCase();
  if (caCorpFormField) {
    caCorpFormField.classList.toggle('hidden', !(isBiz && (bt === 'ccorp' || bt === 'scorp')));
  }

  const showDisclaimersEl = document.getElementById('showDisclaimers');
  if (showDisclaimersEl) showDisclaimersEl.checked = merged.showDisclaimers;

  const stateInfoBox = document.getElementById('stateInfoBox');
  if (stateInfoBox) stateInfoBox.classList.add('hidden');

  renderFederalPayments();
  renderStatesList();

  const previewArea = document.getElementById('previewArea');
  if (previewArea) {
    previewArea.setAttribute('contenteditable', 'false');
    previewArea.style.padding = '';
    previewArea.style.margin = '';
  }
  previewManuallyEdited = false;

  const customizeSection = document.querySelector('.customize-email');
  if (customizeSection) customizeSection.remove();

  const saveBtn = document.getElementById('savePreviewChanges');
  if (saveBtn) saveBtn.style.display = 'none';

  const notice = document.querySelector('.preview-edit-notice');
  if (notice) notice.classList.remove('visible');

  regeneratePreviewHTML();

  const activeStep = document.querySelector('.wizard-step.active');
  if (activeStep?.id === 'step-4') {
    updateReviewStep();
  }
}

// Helper for date formatting
function formatDateToMMDDYYYY(iso) {
  if (!iso) return '';
  const parts = iso.split('-');
  if (parts.length < 3) return iso;
  return `${parts[1]}-${parts[2]}-${parts[0]}`;
}

// Helper for date formatting (general, for bulk import too)
function normalizeDateToMMDDYYYY(value) {
  if (!value && value !== 0) return '';

  // Excel serial number from .xlsx
  if (typeof value === 'number') {
    const excelEpoch = new Date(Date.UTC(1899, 11, 30)); // Excel epoch
    const millis = excelEpoch.getTime() + value * 24 * 60 * 60 * 1000;
    const date = new Date(millis);
    if (!isNaN(date.getTime())) {
      return formatDateObjectToMMDDYYYY(date);
    }
    return '';
  }

  const str = String(value).trim();
  if (!str) return '';

  const parsed = new Date(str.replace(/-/g, '/'));
  if (!isNaN(parsed.getTime())) {
    return formatDateObjectToMMDDYYYY(parsed);
  }

  // Last resort: return as-is
  return str;
}

function formatDateObjectToMMDDYYYY(date) {
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  const yyyy = date.getFullYear();
  return `${mm}-${dd}-${yyyy}`;
}

/** Shared helper to format due dates for Subject/preview header */
function formatDueDateForSubject(rawDate) {
  if (!rawDate) return '';
  const parsed = new Date(String(rawDate).replace(/-/g, '/'));
  if (!isNaN(parsed.getTime())) {
    return parsed.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
  }
  return String(rawDate);
}

/******************************************************************************
 * 4A) CSV/XLSX IMPORT HELPERS (GROUPING)
 *****************************************************************************/

function parseCsvToObjects(text) {
  const cleaned = text.replace(/^\uFEFF/, ''); // strip BOM
  const lines = cleaned.split(/\r?\n/).filter(line => line.trim() !== '');
  if (!lines.length) return [];

  const headerLine = lines[0];
  const headers = splitCsvLine(headerLine).map(h => h.trim());
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i];
    if (!line.trim()) continue;

    const values = splitCsvLine(line);
    const row = {};
    headers.forEach((header, idx) => {
      row[header] = (values[idx] !== undefined ? values[idx] : '').trim();
    });
    rows.push(row);
  }

  return rows;
}

function splitCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

function normalizeStateName(raw) {
  if (raw === undefined || raw === null) return '';
  const val = String(raw).trim();
  if (!val) return '';

  const directMatch = Object.keys(statesData).find(
    name => name.toLowerCase() === val.toLowerCase()
  );
  if (directMatch) return directMatch;

  const upper = val.toUpperCase();
  if (STATE_ABBREVIATIONS[upper] && statesData[STATE_ABBREVIATIONS[upper]]) {
    return STATE_ABBREVIATIONS[upper];
  }

  return '';
}

function groupRowsIntoJobs(rows) {
  const byClient = new Map();

  rows.forEach((row) => {
    const rawClientId = row.ClientId;
    const clientId = rawClientId != null ? String(rawClientId).trim() : '';
    if (!clientId) {
      return; // skip rows without ClientId
    }

    if (!byClient.has(clientId)) {
      byClient.set(clientId, {
        clientId,
        base: extractClientBase(row),
        federalPayments: [],
        statePayments: []
      });
    }

    const job = byClient.get(clientId);
    attachPaymentToJob(job, row);
  });

  const jobs = [];
  byClient.forEach(job => {
    jobs.push({
      clientId: job.clientId,
      data: convertJobToFormDataLike(job)
    });
  });
  return jobs;
}

function extractClientBase(row) {
  return {
    addresseeName: (row.ClientName != null ? String(row.ClientName) : '').trim(),
    senderName: (row.SenderName != null ? String(row.SenderName) : '').trim(),
    paymentDueDate: normalizeDateToMMDDYYYY(row.PayByDate),
    showDueDateReminder: true,
    entityType: String(row.EntityType || 'individual').toLowerCase(),
    businessType: String(row.BusinessType || '').toLowerCase(),
    entityId: (row.EntityId != null ? String(row.EntityId) : '').trim(),
    entityName: (row.EntityName != null ? String(row.EntityName) : '').trim(),
    caCorpForm: (row.CaCorpForm != null ? String(row.CaCorpForm) : '').trim(),
    showDisclaimers: true
  };
}

function attachPaymentToJob(job, row) {
  const scope = String(row.PaymentScope || '').toLowerCase();

  const rawMethod = String(row.Method || '').trim().toLowerCase();
  let method = '';
  if (scope === 'state') {
    method = rawMethod === 'mail' ? 'mail' : 'electronic';
  } else if (scope === 'federal') {
    if (!rawMethod) method = 'direct_pay';
    else if (rawMethod === 'electronic') method = 'direct_pay';
    else if (rawMethod === 'directpay' || rawMethod === 'direct_pay' || rawMethod === 'direct') method = 'direct_pay';
    else if (rawMethod === 'eftps' || rawMethod.includes('eftps')) method = 'eftps';
    else if (rawMethod === 'other') method = 'eftps';
    else method = 'direct_pay';
  } else {
    method = rawMethod;
  }

  const payment = {
    type: row.PaymentType || 'Extension',
    quarter: row.Quarter != null ? String(row.Quarter).trim() : '',
    dueDate: normalizeDateToMMDDYYYY(row.DueDate),
    amount: row.Amount != null ? String(row.Amount).trim() : '',
    description: row.Notes != null ? String(row.Notes).trim() : '',
    taxPeriod: row.TaxYear != null ? String(row.TaxYear).trim() : '',
    method
  };

  if (scope === 'federal') {
    job.federalPayments.push(payment);
  } else if (scope === 'state') {
    const stateName = normalizeStateName(row.State);
    if (!stateName) return;

    if (!job.statePayments) {
      job.statePayments = [];
    }
    let stateEntry = job.statePayments.find(s => s.stateName === stateName);
    if (!stateEntry) {
      stateEntry = { stateName, payments: [] };
      job.statePayments.push(stateEntry);
    }
    stateEntry.payments.push(payment);
  }
}

function convertJobToFormDataLike(job) {
  const base = job.base || {};
  return {
    addresseeName: base.addresseeName || '',
    paymentDueDate: base.paymentDueDate || '',
    senderName: base.senderName || '',
    showDueDateReminder: base.showDueDateReminder !== undefined ? base.showDueDateReminder : true,
    federalPayments: job.federalPayments || [],
    statePayments: job.statePayments || [],
    entityType: base.entityType || 'individual',
    businessType: base.businessType || '',
    entityId: base.entityId || '',
    entityName: base.entityName || '',
    caCorpForm: base.caCorpForm || '',
    showDisclaimers: base.showDisclaimers !== undefined ? base.showDisclaimers : true
  };
}

/******************************************************************************
 * 5) FEDERAL PAYMENTS
 *****************************************************************************/
const IRS_DIRECT_PAY_SUPPORTED_BUSINESS_FORMS = new Set([
  '1065',
  '1120',
  '1120-S'
]);

function normalizeFederalMethod(value) {
  const s = String(value ?? '').trim().toLowerCase();
  if (!s) return '';

  if (s === 'direct_pay' || s === 'directpay' || s === 'direct') return 'direct_pay';
  if (s === 'electronic') return 'direct_pay';
  if (s === 'eftps' || s.includes('eftps')) return 'eftps';
  if (s === 'other') return 'eftps';
  return '';
}

function getBusinessReturnFormForDirectPay(data) {
  const bt = String(data?.businessType || '').toLowerCase();
  switch (bt) {
    case 'ccorp':
      return '1120';
    case 'scorp':
      return '1120-S';
    case 'partnership':
      return '1065';
    case 'llc':
      // LLC filing form can vary; 1065 is a common default for multi-member LLCs.
      return '1065';
    default:
      return '';
  }
}

function recommendedBusinessFederalMethod(data) {
  const form = getBusinessReturnFormForDirectPay(data);
  if (!form) return 'direct_pay';
  return IRS_DIRECT_PAY_SUPPORTED_BUSINESS_FORMS.has(form) ? 'direct_pay' : 'eftps';
}

function addFederalPayment() {
  const payByIso = document.getElementById('paymentDueDate')?.value || defaultPayByDateISO();
  const taxPeriod = inferTaxYearForPayment({
    paymentType: 'Extension',
    quarter: '',
    dueDate: '',
    payByDate: payByIso
  });
  const method = formData.entityType === 'business'
    ? recommendedBusinessFederalMethod(formData)
    : 'direct_pay';

  formData.federalPayments.push({
    type: 'Extension',
    quarter: '',
    dueDate: '',
    amount: '',
    description: '',
    taxPeriod,
    method
  });
  renderFederalPayments();
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function updateFederalPayment(idx, field, val, skipRender=false) {
  const fp = formData.federalPayments[idx];

  if (field === 'type') {
    const isEstimated = String(val || '').toLowerCase().includes('estimated');
    if (!isEstimated) fp.quarter = '';

    const hasTaxYear = String(fp.taxPeriod || '').trim() !== '';
    if (!hasTaxYear) {
      const payByIso = document.getElementById('paymentDueDate')?.value || '';
      fp.taxPeriod = inferTaxYearForPayment({
        paymentType: val,
        quarter: fp.quarter,
        dueDate: fp.dueDate,
        payByDate: payByIso
      });
    }
  }
  if (field === 'dueDate') {
    fp.dueDate = formatDateToMMDDYYYY(val);
  } else if (field === 'method') {
    fp.method = val;
  } else {
    fp[field] = val;
  }
  if (!skipRender) renderFederalPayments();
  regeneratePreviewHTML();
  syncSessionAfterChange({ render: false });
}

function removeFederalPayment(idx) {
  formData.federalPayments.splice(idx, 1);
  renderFederalPayments();
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function renderFederalPayments() {
  const container = document.getElementById('federalPaymentsContainer');
  container.innerHTML = '';
  if (!formData.federalPayments.length) return;

  const isBiz = formData.entityType === 'business';

  let html = `<div class="table-container"><table>
    <tr>
      <th>Type, Quarter & Method</th>
      <th>Due Date & Amount</th>
      <th>Tax Period & Notes</th>
      <th></th>
    </tr>`;
  formData.federalPayments.forEach((p, idx) => {
    const method = normalizeFederalMethod(p.method) || (isBiz ? recommendedBusinessFederalMethod(formData) : 'direct_pay');
    html += `<tr>
      <td>
        <div class="stacked-form-cell">
          <label>Payment Type</label>
          <select onchange="updateFederalPayment(${idx}, 'type', this.value)"
                  title="Extension, Estimated, or Balance Due">
            <option value="Extension" ${p.type==='Extension' ? 'selected' : ''}>Extension</option>
            <option value="Estimated" ${p.type==='Estimated' ? 'selected' : ''}>Estimated</option>
            <option value="Balance Due" ${p.type==='Balance Due' ? 'selected' : ''}>Balance Due</option>
          </select>
          <div class="helper-text">Choose payment type</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Quarter</label>
          <!-- condition below allows quarter only if p.type includes 'estimated' -->
          <select onchange="updateFederalPayment(${idx}, 'quarter', this.value)"
                  ${p.type && p.type.toLowerCase().includes('estimated') ? '' : 'disabled'}>
            <option value="">--</option>
            <option value="Q1" ${p.quarter==='Q1'?'selected':''}>Q1</option>
            <option value="Q2" ${p.quarter==='Q2'?'selected':''}>Q2</option>
            <option value="Q3" ${p.quarter==='Q3'?'selected':''}>Q3</option>
            <option value="Q4" ${p.quarter==='Q4'?'selected':''}>Q4</option>
          </select>
          <div class="helper-text">For estimated tax only</div>
        </div>
        ${
          isBiz
            ? `<div class="stacked-form-cell" style="margin-top: 12px;">
                <label>Method</label>
                <select onchange="updateFederalPayment(${idx}, 'method', this.value)">
                  <option value="direct_pay" ${method === 'direct_pay' ? 'selected' : ''}>IRS Direct Pay (if available)</option>
                  <option value="eftps" ${method === 'eftps' ? 'selected' : ''}>EFTPS / other IRS options</option>
                </select>
                <div class="helper-text">If Direct Pay doesn’t show your form, use another IRS method</div>
              </div>`
            : ''
        }
      </td>
      <td>
        <div class="stacked-form-cell">
          <label>Due Date</label>
          <input type="date"
                 value="${reverseFormatDateToYYYYMMDD(p.dueDate)}"
                 onchange="updateFederalPayment(${idx}, 'dueDate', this.value)"
                 placeholder="MM/DD/YYYY" />
          <div class="helper-text">Deadline</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Amount</label>
          <input type="number"
                 value="${p.amount}"
                 placeholder="e.g. 1000"
                 oninput="updateFederalPayment(${idx}, 'amount', this.value, true)" />
          <div class="helper-text">Whole dollars</div>
        </div>
      </td>
      <td>
        <div class="stacked-form-cell">
          <label>Tax Period</label>
          <input type="number"
                 min="2000"
                 max="2100"
                 value="${p.taxPeriod || ''}"
                 oninput="updateFederalPayment(${idx}, 'taxPeriod', this.value, true)" />
          <div class="helper-text">e.g. 2025</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Notes</label>
          <textarea rows="3"
                    placeholder="Optional notes"
                    oninput="updateFederalPayment(${idx}, 'description', this.value, true)">${p.description||''}</textarea>
          <div class="helper-text">Add details</div>
        </div>
      </td>
      <td>
        <button type="button" onclick="removeFederalPayment(${idx})" style="margin-top:24px;">
          Remove
        </button>
      </td>
    </tr>`;
  });
  html += '</table></div>';
  container.innerHTML = html;
}

function reverseFormatDateToYYYYMMDD(mdy) {
  if (!mdy || !mdy.includes('-')) return '';
  const parts = mdy.split('-');
  if (parts.length < 3) return '';
  return `${parts[2]}-${parts[0]}-${parts[1]}`;
}

/******************************************************************************
 * 6) STATE PAYMENTS
 *****************************************************************************/
function onAdditionalStateChange() {
  const sel = document.getElementById('addStateSelector');
  const val = sel.value;
  if (!val) return;

  if (!formData.statePayments.find(s => s.stateName === val)) {
    formData.statePayments.push({
      stateName: val,
      payments: []
    });
    renderStatesList();
  }
  displayStateInfo(val);
  sel.value = '';
  regeneratePreviewHTML();
  syncSessionAfterChange({ render: false });
}

function renderStatesList() {
  const listDiv = document.getElementById('statesList');
  listDiv.innerHTML = '';
  formData.statePayments.forEach((st, idx) => {
    const container = document.createElement('div');
    container.className = 'state-section';

    // Conditionally show "Add PTE Payment" if business + pteForm != 'N/A'
    const showPTE =
      formData.entityType === 'business' &&
      (statesData[st.stateName]?.pteForm || "N/A") !== "N/A";

    let html =
      `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <h3 style="margin:0;">${st.stateName}</h3>
        <button type="button" onclick="removeState(${idx})" style="background:#dc3545;color:white">
          Remove State
        </button>
      </div>
      <button type="button" onclick="addPaymentToState(${idx})" class="add-payment-button">
        + Add Payment
      </button>`;

    if (showPTE) {
      html += `
      <button type="button" onclick="addPTEPayment(${idx})"
              class="add-payment-button" 
              style="background:#a855f7;margin-left:8px;">
        + Add PTE Payment
      </button>`;
    }
    html += `<div id="statePayments-${idx}" style="margin-top:10px;"></div>`;
    container.innerHTML = html;
    listDiv.appendChild(container);

    renderStatePayments(idx);
  });
}

function removeState(idx) {
  formData.statePayments.splice(idx, 1);
  renderStatesList();
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function addPaymentToState(stateIdx) {
  const stateObj = formData.statePayments[stateIdx];
  const { stateName } = stateObj;

  // default to "Extension"
  let defaultType = 'Extension';
  if (stateName === 'California' && formData.entityType === 'business') {
    defaultType = 'originalReturnPayment';
  }

  const payByIso = document.getElementById('paymentDueDate')?.value || defaultPayByDateISO();
  const taxPeriod = inferTaxYearForPayment({
    paymentType: defaultType,
    quarter: '',
    dueDate: '',
    payByDate: payByIso
  });

  stateObj.payments.push({
    type: defaultType,
    quarter: '',
    dueDate: '',
    amount: '',
    description: '',
    taxPeriod,
    method: 'electronic'
  });
  renderStatePayments(stateIdx);
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function addPTEPayment(stateIdx) {
  const stateObj = formData.statePayments[stateIdx];
  const { stateName } = stateObj;

  let pteType = 'PTE';
  if (stateName === 'California' && formData.entityType === 'business') {
    pteType = 'pte'; 
  }

  const payByIso = document.getElementById('paymentDueDate')?.value || defaultPayByDateISO();
  const taxPeriod = inferTaxYearForPayment({
    paymentType: pteType,
    quarter: '',
    dueDate: '',
    payByDate: payByIso
  });

  stateObj.payments.push({
    type: pteType,
    dueDate: '',
    amount: '',
    description: '',
    taxPeriod,
    method: 'electronic'
  });
  renderStatePayments(stateIdx);
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

function removeStatePayment(stateIdx, pmtIdx) {
  formData.statePayments[stateIdx].payments.splice(pmtIdx, 1);
  renderStatesList();
  regeneratePreviewHTML();
  syncSessionAfterChange();
}

/**
 * This is where we add the substring checks for 'extension', 'estimated', 'balance', etc.
 * so that "Estimated Tax Payment (Form 540-ES)" triggers a default taxPeriod or other logic.
 */
function updateStatePayment(stateIdx, pmtIdx, field, value, shouldReRender = true) {
  const st = formData.statePayments[stateIdx];
  const payment = st.payments[pmtIdx];

  // 1) If the user changed the "type" field, run substring checks:
  if (field === 'type') {
    const lower = String(value || '').toLowerCase();
    const isEstimated = lower.includes('estimated');
    if (!isEstimated) {
      payment.quarter = '';
    }

    const hasTaxYear = String(payment.taxPeriod || '').trim() !== '';
    if (!hasTaxYear) {
      const payByIso = document.getElementById('paymentDueDate')?.value || '';
      payment.taxPeriod = inferTaxYearForPayment({
        paymentType: value,
        quarter: payment.quarter,
        dueDate: payment.dueDate,
        payByDate: payByIso
      });
    }
  }

  if (field === 'method') {
    payment.method = value;
  }

  // 2) Now set the field value (like dueDate or quarter, etc.)
  if (field === 'dueDate') {
    payment[field] = formatDateToMMDDYYYY(value);
  } else {
    payment[field] = value;
  }

  if (shouldReRender) {
    renderStatePayments(stateIdx);
  }
  regeneratePreviewHTML();
  syncSessionAfterChange({ render: false });
}

function renderStatePayments(stateIdx) {
  const container = document.getElementById(`statePayments-${stateIdx}`);
  if (!container) return;
  
  const st = formData.statePayments[stateIdx];
  if (!st) return;

  const stateName = st.stateName;
  const isCA = (stateName === 'California');
  const isBiz = (formData.entityType === 'business');

  let paymentTypeMap = getStatePaymentTypeMap(stateName);

  let html = `<div class="table-container">
    <table>
      <tr>
        <th>Payment Type & Quarter</th>
        <th>Due Date & Amount</th>
        <th>Tax Year & Notes</th>
        <th></th>
      </tr>`;

  st.payments.forEach((p, pmtIdx) => {
    let selectOptions = '';

    if (paymentTypeMap) {
      Object.keys(paymentTypeMap).forEach(k => {
        const lbl = paymentTypeMap[k].label;
        const selected = (p.type === k) ? 'selected' : '';
        selectOptions += `<option value="${k}" ${selected}>${lbl}</option>`;
      });
    } else {
      if (stateName === 'California' && !isBiz) {
        const simpleTypes = [
          "Estimated Tax Payment (Form 540-ES)",
          "Bill Payment",
          "Tax Return Payment",
          "Amended Tax Return Payment",
          "Extension Payment (Form 3519)",
          "Notice of Proposed Assessment or Form 3834 Payment",
          "Pending Audit Tax Deposit Payment (Form 3576)"
        ];
        simpleTypes.forEach(t => {
          const sel = (p.type === t) ? 'selected' : '';
          selectOptions += `<option value="${t}" ${sel}>${t}</option>`;
        });
      }
      else {
        const simpleTypes = ["Extension", "Estimated", "Balance Due", "PTE"];
        simpleTypes.forEach(t => {
          const sel = (p.type === t) ? 'selected' : '';
          selectOptions += `<option value="${t}" ${sel}>${t}</option>`;
        });
      }
    }

    // If "estimated" is in p.type, enable quarter
    const quarterEnabled = p.type && p.type.toLowerCase().includes('estimated');

    html += `<tr>
      <td>
        <div class="stacked-form-cell">
          <label>Payment Type</label>
          <select onchange="updateStatePayment(${stateIdx}, ${pmtIdx}, 'type', this.value)"
                  title="Select the payment type">
            ${selectOptions}
          </select>
          <div class="helper-text">Select payment type</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Method</label>
          <select onchange="updateStatePayment(${stateIdx}, ${pmtIdx}, 'method', this.value)">
            <option value="electronic" ${p.method==='electronic'?'selected':''}>Electronic</option>
            <option value="mail" ${p.method==='mail'?'selected':''}>Pay by Mail</option>
          </select>
          <div class="helper-text">How will you pay?</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Quarter</label>
          <select onchange="updateStatePayment(${stateIdx}, ${pmtIdx}, 'quarter', this.value)"
                  ${quarterEnabled ? '' : 'disabled'}>
            <option value="">--</option>
            <option value="Q1" ${p.quarter==='Q1'?'selected':''}>Q1</option>
            <option value="Q2" ${p.quarter==='Q2'?'selected':''}>Q2</option>
            <option value="Q3" ${p.quarter==='Q3'?'selected':''}>Q3</option>
            <option value="Q4" ${p.quarter==='Q4'?'selected':''}>Q4</option>
          </select>
          <div class="helper-text">For Estimated-type payments</div>
        </div>
      </td>
      <td>
        <div class="stacked-form-cell">
          <label>Due Date</label>
          <input type="date"
                 value="${reverseFormatDateToYYYYMMDD(p.dueDate)}"
                 oninput="updateStatePayment(${stateIdx}, ${pmtIdx}, 'dueDate', this.value, false)" />
          <div class="helper-text">State's deadline</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Amount</label>
          <input type="number"
                 value="${p.amount}"
                 placeholder="e.g. 1000"
                 oninput="updateStatePayment(${stateIdx}, ${pmtIdx}, 'amount', this.value, false)" />
          <div class="helper-text">Whole dollars only</div>
        </div>
      </td>
      <td>
        <div class="stacked-form-cell">
          <label>Tax Year</label>
          <input type="number" min="2000" max="2100" value="${p.taxPeriod || ''}"
                 oninput="updateStatePayment(${stateIdx}, ${pmtIdx}, 'taxPeriod', this.value, false)" />
          <div class="helper-text">E.g., 2025</div>
        </div>
        <div class="stacked-form-cell" style="margin-top: 12px;">
          <label>Notes</label>
          <textarea rows="3"
                    placeholder="Optional notes"
                    oninput="updateStatePayment(${stateIdx}, ${pmtIdx}, 'description', this.value, false)">${p.description||''}</textarea>
          <div class="helper-text">Additional details if needed</div>
        </div>
      </td>
      <td>
        <button type="button" onclick="removeStatePayment(${stateIdx}, ${pmtIdx})" style="margin-top:24px;">
          Remove
        </button>
      </td>
    </tr>`;
  });

  html += `</table></div>`;
  container.innerHTML = html;
}

function displayStateInfo(stateName) {
  const box = document.getElementById('stateInfoBox');
  if (!statesData[stateName]) {
    box.classList.add('hidden');
    return;
  }
  box.classList.remove('hidden');
  document.getElementById('stateInfoHeader').textContent = `${stateName} - Overview`;

  const data = statesData[stateName];
  let infoHtml = `
**Tax Agency Name**: ${data.taxAgencyName || ''}
**Estimated Tax Payments**: ${data.estimatedTaxText || ''}
**Extension Payment Info**: ${data.extensionText || ''}
**Pass-Through Entity (PTE) Elective Tax**: ${data.pteText || ''}
**Online Payment Process**: ${data.onlinePayProcess || ''}
**Additional Comments**: ${data.additionalComments || ''}`;

  const safeHtml = infoHtml
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br/>');

  document.getElementById('stateInfoContent').innerHTML = safeHtml;
}

/******************************************************************************
 * 7) PREVIEW & DOWNLOAD (.eml)
 *****************************************************************************/
function regeneratePreviewHTML() {
  const previewArea = document.getElementById('previewArea');
  if (!previewArea) return;

  generatedEmailHTML = buildEmailHTML();

  const isEditable = previewArea.getAttribute('contenteditable') === 'true';
  const shouldOverwritePreview = !isEditable || (isEditable && !previewManuallyEdited);
  if (shouldOverwritePreview) {
    previewArea.innerHTML = generatedEmailHTML;
  }

  updatePayByDateWarning();
}

function getDisplayedBusinessType(bizType) {
  switch(bizType) {
    case 'ccorp': return 'C-Corporation';
    case 'scorp': return 'S-Corporation';
    case 'partnership': return 'Partnership';
    case 'llc': return 'Limited Liability Company (LLC)';
    default: return bizType || '[Entity Type]';
  }
}

/** Pure builder: takes a data object and options, returns full email HTML */
function buildEmailHTMLFromData(data, options = {}) {
  const includePreviewHeader = options.includePreviewHeader !== false;
  const dateStr = escapeHTML(formatDueDateForSubject(data.paymentDueDate));
  const addressee = escapeHTML(data.addresseeName || '');
  const sender = escapeHTML(data.senderName || '');
  const portalUrl = safeUrl(options.portalUrl || '');

  const greetingText = options.greeting != null
    ? String(options.greeting)
    : (data.addresseeName ? `Hi ${data.addresseeName},` : 'Hi,');
  const greeting = plainTextToHtml(greetingText);

  const personalNote = options.personalNote ? plainTextToHtml(options.personalNote) : '';
  const includeDisclaimers =
    options.includeDisclaimers !== undefined
      ? options.includeDisclaimers
      : (data.showDisclaimers ?? true);

  let html = '';

  if (includePreviewHeader) {
    html += `
<div class="email-header">
  <div class="email-header-field">
    <span class="email-header-label">From:</span>
    <span>${sender || '(Not set)'}</span>
  </div>
  <div class="email-header-field">
    <span class="email-header-label">To:</span>
    <span>${addressee || '(Not set)'}</span>
  </div>
  <div class="email-header-field">
    <span class="email-header-label">Subject:</span>
    <span>Tax Payment Instructions - Due ${dateStr || '[Date]'}</span>
  </div>
</div>
`;
  }

  html += `
<div class="email-body">
  ${greeting}<br><br>
  Here are the electronic payment instructions.<br>`;

  if (data.showDueDateReminder && dateStr) {
    html += `Please be sure to pay by ${dateStr}.<br><br>`;
  } else {
    html += `<br>`;
  }

  if (portalUrl) {
    html += `View and confirm your payments here: <a href="${portalUrl}" target="_blank" rel="noopener noreferrer">Open checklist</a><br><br>`;
  }

  if (Array.isArray(data.federalPayments) && data.federalPayments.length) {
    data.federalPayments.forEach(p => {
      html += buildFederalPaymentSectionForData(p, data);
    });
  }

  if (Array.isArray(data.statePayments) && data.statePayments.length) {
    data.statePayments.forEach(st => {
      (st.payments || []).forEach(p => {
        html += buildStatePaymentSectionForData(st.stateName, p, data);
      });
    });
  }

  if (personalNote) {
    html += `<br>${personalNote}<br>`;
  }

  if (includeDisclaimers) {
    const irsGov = safeUrl('https://www.irs.gov');
    const ftbGov = safeUrl('https://www.ftb.ca.gov');
    const irsDirectPay = safeUrl('https://www.irs.gov/payments/direct-pay');
    const ftbWebPay = safeUrl('https://webapp.ftb.ca.gov/webpay');

    html += `
<br><strong>Important Notes & References:</strong>
<ul style="margin-top:8px;">
  <li><strong>Extension is not an extension to pay.</strong> Unpaid taxes after the deadline may incur penalties &amp; interest. (See <a href="${irsGov}" target="_blank" rel="noopener noreferrer">IRS.gov</a> and <a href="${ftbGov}" target="_blank" rel="noopener noreferrer">FTB.ca.gov</a>)</li>
  <li><strong>Choose correct tax year/form:</strong> e.g., if extending 2025 taxes in April 2026, select 2025 for “Extension.”</li>
  <li><strong>Payment confirmation:</strong> Always save the confirmation number or email from the IRS or FTB.</li>
  <li>For complete step-by-step instructions, see the official references at <a href="${irsDirectPay}" target="_blank" rel="noopener noreferrer">IRS Direct Pay</a> and <a href="${ftbWebPay}" target="_blank" rel="noopener noreferrer">CA FTB Web Pay</a>.</li>
</ul>
`;
  }

  html += `
<br>
Please confirm receipt and send payment confirmations once done. 
Let me know if you have questions!<br><br>
Thank you,<br>
${sender || ''}
</div>
`;
  return html;
}

/** Wrapper for the existing single-client wizard; pulls greeting / note from DOM */
function buildEmailHTML() {
  const greetingInput = document.getElementById('customGreeting');
  const personalNoteInput = document.getElementById('personalNote');

  const greeting = greetingInput && greetingInput.value
    ? greetingInput.value
    : `Hi ${formData.addresseeName || ''},`;

  const personalNote = personalNoteInput && personalNoteInput.value
    ? personalNoteInput.value
    : '';

  return buildEmailHTMLFromData(formData, {
    greeting,
    personalNote,
    includeDisclaimers: formData.showDisclaimers,
    includePreviewHeader: true,
    portalUrl: portalUrlsByClientId[activeClientId] || ''
  });
}

function buildFederalPaymentSectionForData(p, data) {
  const due = String(p.dueDate || '');
  const dateStr = due
    ? new Date(due.replace(/-/g, '/')).toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      })
    : '';

  const taxYear = escapeHTML(p.taxPeriod || '[Tax Year]');
  const isBiz = (data.entityType === 'business');

  let desc = '';
  const type = String(p.type || '');
  const typeLower = type.toLowerCase();
  const isEstimated = typeLower.includes('estimated');
  const isExtension = typeLower.includes('extension');
  const isBalanceDue = typeLower.includes('balance');

  if (!isBiz) {
    const extForm = '4868';
    const estForm = '1040-ES';
    const balLabel = 'Balance Due (1040)';

    if (type === 'Extension') {
      desc = `Extension Payment (Form ${extForm}) for tax year ${taxYear}.`;
    } else if (type === 'Estimated') {
      desc = `Estimated Tax Payment (Form ${estForm}) for tax year ${taxYear}`;
      if (p.quarter) {
        desc += ` (Quarter: ${escapeHTML(p.quarter)})`;
      }
      desc += '.';
    } else if (type === 'Balance Due') {
      desc = `${balLabel} for tax year ${taxYear}.`;
    } else {
      desc = `Federal Payment: ${escapeHTML(type)} for tax year ${taxYear}.`;
    }
  } else {
    if (isExtension) {
      desc = `Federal Extension Payment for tax year ${taxYear}.`;
    } else if (isEstimated) {
      desc = `Federal Estimated Tax Payment for tax year ${taxYear}`;
      if (p.quarter) {
        desc += ` (Quarter: ${escapeHTML(p.quarter)})`;
      }
      desc += '.';
    } else if (isBalanceDue) {
      desc = `Federal Tax Return / Balance Due Payment for tax year ${taxYear}.`;
    } else {
      desc = `Federal Payment: ${escapeHTML(type)} for tax year ${taxYear}.`;
    }
  }

  const amount = formatCurrency(p.amount);
  const notes = p.description ? plainTextToHtml(p.description) : '';
  const irsDirectPay = safeUrl('https://www.irs.gov/payments/direct-pay');
  const irsPayments = safeUrl('https://www.irs.gov/payments');
  const eftpsUrl = safeUrl('https://www.eftps.gov/eftps/');

  let html = `
<div style="margin-bottom:20px;padding:15px;background:#eef6ff;border-radius:8px;border:1px solid #e2e8f0;">
  <div style="margin-bottom:12px;">${desc}</div>
  <span style="background-color: #FFFF00; font-weight:bold; padding:4px 8px; border-radius:4px;">
    Please pay ${amount} to the US Treasury
  </span>
  ${dateStr ? `<div style="margin-top:12px;"><strong>Due Date:</strong> ${escapeHTML(dateStr)}</div>` : ''}
  ${notes ? `<div style="margin-top:8px;"><strong>Additional Notes:</strong> ${notes}</div>` : ''}
`;

  if (isBiz) {
    const bt = String(data.businessType || '').toLowerCase();
    const returnForm = getBusinessReturnFormForDirectPay(data);
    const hasReturnForm = Boolean(returnForm);
    const directPaySupported = hasReturnForm && IRS_DIRECT_PAY_SUPPORTED_BUSINESS_FORMS.has(returnForm);
    const method = normalizeFederalMethod(p.method) || recommendedBusinessFederalMethod(data);

    let reason = '';
    if (isExtension) reason = 'Extension';
    else if (isEstimated) reason = 'Estimated Tax';
    else if (isBalanceDue) reason = 'Tax Return / Notice';
    else reason = 'Tax Return / Notice';

    if (method === 'direct_pay') {
      const llcNote = bt === 'llc'
        ? `<div style="margin-top:10px;color:#475569;font-size:0.95em;"><em>Note:</em> LLC filing forms can vary. If your LLC files a different federal return, select that form in Direct Pay.</div>`
        : '';

      const supportNote = !directPaySupported
        ? `<div style="margin-top:10px;color:#b45309;font-size:0.95em;"><strong>Heads up:</strong> If you don’t see your form/reason in Direct Pay, use another IRS payment method below.</div>`
        : '';

      html += `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>IRS Direct Pay Instructions (Business):</strong><br/>
    1. Go to <a href="${irsDirectPay}" target="_blank" rel="noopener noreferrer">irs.gov/payments/direct-pay</a> and start a payment.<br/>
    2. Choose <strong>Business</strong> (if prompted), then select:
       <ul style="margin:6px 0 0 20px;">
         <li>Reason for Payment: ${escapeHTML(reason)}</li>
         ${hasReturnForm ? `<li>Apply Payment To (Form): ${escapeHTML(returnForm)}</li>` : ''}
         <li>Tax Year: ${taxYear}</li>
         <li>Amount: ${amount}</li>
       </ul>
    3. Complete identity verification and submit the payment (have your EIN and prior-year info available if requested).
    ${llcNote}
    ${supportNote}
  </div>
`;
      if (!directPaySupported) {
        const paymentsLink = irsPayments
          ? `<a href="${irsPayments}" target="_blank" rel="noopener noreferrer">irs.gov/payments</a>`
          : 'irs.gov/payments';
        const eftpsLink = eftpsUrl
          ? `<a href="${eftpsUrl}" target="_blank" rel="noopener noreferrer">eftps.gov</a>`
          : 'eftps.gov';

        html += `
  <div style="margin-top:12px;padding-top:12px;border-top:1px dashed #e2e8f0;">
    <strong>Other IRS payment options (Business):</strong><br/>
    If Direct Pay doesn’t show the option you need, use another IRS method (often EFTPS for businesses).<br/>
    1. See IRS options at ${paymentsLink}<br/>
    2. If using EFTPS, go to ${eftpsLink} and follow the prompts for your form/tax year.
  </div>
`;
      }
      html += `</div>`;
      return html;
    }

    const paymentsLink = irsPayments
      ? `<a href="${irsPayments}" target="_blank" rel="noopener noreferrer">irs.gov/payments</a>`
      : 'irs.gov/payments';
    const eftpsLink = eftpsUrl
      ? `<a href="${eftpsUrl}" target="_blank" rel="noopener noreferrer">eftps.gov</a>`
      : 'eftps.gov';

    html += `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>IRS payment options (Business):</strong><br/>
    If IRS Direct Pay doesn’t show your form/reason (or if you prefer a different method), use another IRS option (often EFTPS for businesses).<br/>
    1. See IRS options at ${paymentsLink}<br/>
    2. If using EFTPS, go to ${eftpsLink} and follow the prompts for your form/tax year.
  </div>
</div>
`;
  } else {
    let paymentReasonTitle = '';
    if (p.type === 'Extension') paymentReasonTitle = 'Extension (Form 4868)';
    else if (p.type === 'Estimated') paymentReasonTitle = 'Estimated (Form 1040-ES)';
    else if (p.type === 'Balance Due') paymentReasonTitle = 'Balance Due (Form 1040)';

    const formCode =
      p.type === 'Extension' ? '4868'
      : p.type === 'Estimated' ? '1040-ES'
      : p.type === 'Balance Due' ? '1040'
      : '';

    html += `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>IRS Direct Pay Instructions (Individual - ${escapeHTML(paymentReasonTitle)}):</strong><br/>
    1. Go to <a href="${irsDirectPay}" target="_blank" rel="noopener noreferrer">irs.gov/payments/direct-pay</a> and click "Pay Individual Tax".<br/>
    2. Select "Make a payment"<br/>
    3. Select:
       <ul style="margin:6px 0 0 20px;">
         <li>Reason for Payment: ${escapeHTML(p.type)}</li>
         <li>Form: ${escapeHTML(formCode)}</li>
         <li>Tax Year: ${taxYear}</li>
         <li>Amount: ${amount}</li>
       </ul>
    4. Verify your identity (using a prior-year return), enter your bank information, review the details, and submit.
  </div>
</div>
`;
  }

  return html;
}

/** Backwards-compatible wrapper for existing single-client callers */
function buildFederalPaymentSection(p) {
  return buildFederalPaymentSectionForData(p, formData);
}

function buildStatePaymentSectionForData(stateName, p, data) {
  const dueDateStr = p.dueDate
    ? new Date(String(p.dueDate).replace(/-/g, '/')).toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      })
    : '';
  const paymentDateStr = p.paymentDate
    ? new Date(String(p.paymentDate).replace(/-/g, '/')).toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      })
    : '';
  const stData = statesData[stateName];
  if (!stData) {
    return `<p style="color:red;">[Missing state data for ${escapeHTML(stateName)}]</p>`;
  }
  const taxYear = escapeHTML(p.taxPeriod || '[Tax Year]');
  const isBiz = data.entityType === 'business';
  const entityId = escapeHTML(data.entityId || '[Entity ID]');
  const entityName = escapeHTML(data.entityName || '[Entity Name]');
  const entityType = escapeHTML(getDisplayedBusinessType(data.businessType));

  let payUrl = isBiz ? stData.paymentUrlBusiness : stData.paymentUrlIndividual;
  payUrl = safeUrl(payUrl);

  let paymentTypeMap = getStatePaymentTypeMap(stateName, data);

  let label = '';
  let formNumber = '';
  if (paymentTypeMap && paymentTypeMap[p.type]) {
    label = paymentTypeMap[p.type].label;
    formNumber = paymentTypeMap[p.type].form || '';
  } else {
    const typeLower = (p.type || '').toLowerCase();
    if (typeLower.includes('extension')) {
      label = 'Extension Payment';
      formNumber = isBiz ? stData.extensionFormBusiness : stData.extensionFormIndividual;
    } else if (typeLower.includes('estimated')) {
      label = 'Estimated Tax Payment';
      formNumber = isBiz ? stData.estimateFormBusiness : stData.estimateFormIndividual;
    } else if (typeLower.includes('tax return')) {
      label = 'Tax Return Payment';
      formNumber = 'Form 540 (Balance Due)';
    } else if (typeLower.includes('balance')) {
      label = 'Balance Due Payment';
    } else if (typeLower.includes('pte')) {
      label = 'Pass-Through Entity Payment';
      formNumber = stData.pteForm || '[PTE Form]';
    } else {
      label = String(p.type || '');
    }
  }

  const safeLabel = escapeHTML(label);
  const safeStateName = escapeHTML(stateName);
  const safeAgency = escapeHTML(stData.taxAgencyName || (stateName + ' Department of Revenue'));

  let desc = `${safeLabel}`;
  if (formNumber) desc += ` (Form ${escapeHTML(formNumber)})`;
  desc += ` for ${safeStateName}, tax year ${taxYear}`;
  if (p.quarter) desc += ` (Quarter: ${escapeHTML(p.quarter)})`;
  desc += '.';

  const isCA = stateName === 'California';
  const bgColor = isCA ? '#fef2f6' : '#f8fafc';

  const isCAPTE =
    isCA &&
    isBiz &&
    safeLabel.toLowerCase().includes('pass-through entity');

  const caForm = isCAPTE
    ? (formNumber || 'Form 3893')
    : (data.caCorpForm || formNumber || '');

  const amount = formatCurrency(p.amount);
  const notes = p.description ? plainTextToHtml(p.description) : '';

  let instructions = '';
  if (p.method === 'mail') {
    instructions = `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>Mailing Instructions:</strong><br/>
    1. Print the required state voucher from the payment portal or notice (if applicable).<br/>
    2. Mail the voucher and your check to the address shown on the voucher/notice.<br/>
  </div>`;
  } else if (p.method === 'electronic' && isCAPTE) {
    const link = payUrl
      ? `<a href="${payUrl}" target="_blank" rel="noopener noreferrer">${escapeHTML(payUrl)}</a>`
      : '(state portal link not set)';
    instructions = `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>Payment Instructions (CA PTE – ${escapeHTML(caForm)}):</strong><br/>
    1. Go to ${link}<br/>
    2. When prompted, enter:
      <ul style="margin:6px 0 0 20px;">
        <li>Entity Name: ${entityName}</li>
        <li>Entity Type: ${entityType}</li>
        <li>Entity ID: ${entityId}</li>
        <li>Form: ${escapeHTML(caForm)}</li>
        <li>Payment Type: Pass-Through Entity Elective Tax (Form 3893)</li>
        <li>Period Beginning Date: January 1, ${taxYear} through December 31, ${taxYear}</li>
        <li>Payment Amount: ${amount}</li>
        <li>Payment Date: ${escapeHTML(paymentDateStr || '[Select Payment Date]')}</li>
      </ul>
  </div>`;
  } else {
    const link = payUrl
      ? `<a href="${payUrl}" target="_blank" rel="noopener noreferrer">${escapeHTML(payUrl)}</a>`
      : '(state portal link not set)';

    const entityLines = isBiz
      ? `
        <li>Entity Name: ${entityName}</li>
        <li>Entity Type: ${entityType}</li>
        <li>Entity ID: ${entityId}</li>
        ${formNumber ? `<li>Form: ${escapeHTML(formNumber)}</li>` : ''}`
      : (formNumber ? `<li>Form: ${escapeHTML(formNumber)}</li>` : '');

    instructions = `
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <strong>Payment Instructions:</strong><br/>
    1. Go to ${link}<br/>
    2. Enter:
      <ul style="margin:6px 0 0 20px;">
        ${entityLines}
        <li>Tax Year: ${taxYear}</li>
        <li>Amount: ${amount}</li>
      </ul>
    3. Submit "${safeLabel}" payment as directed.
  </div>`;
  }

  return `
<div style="margin-bottom:20px;padding:15px;background:${bgColor};border-radius:8px;border:1px solid #e2e8f0;">
  <div style="margin-bottom:12px;">${desc}</div>
  <span style="background-color: #FFFF00; font-weight:bold; padding:4px 8px; border-radius:4px;">
    Please pay ${amount} to ${safeAgency}
  </span>
    ${
      dueDateStr
        ? `<div style="margin-top:12px;"><strong>Due Date:</strong> ${escapeHTML(dueDateStr)}</div>`
        : ''
    }
  ${
    notes
      ? `<div style="margin-top:8px;"><strong>Additional Notes:</strong> ${notes}</div>`
      : ''
  }
  ${instructions}
</div>
`;
}

/** Backwards-compatible wrapper for existing single-client callers */
function buildStatePaymentSection(stateName, p) {
  return buildStatePaymentSectionForData(stateName, p, formData);
}

function formatCurrency(amt) {
  const s = String(amt ?? '').trim();
  if (!s) return '[Amount]';

  const num = Number(s);
  if (!isFinite(num)) return '[Amount]';

  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(num);
}

/******************************************************************************
 * 8) ENABLE EDITING / DOWNLOAD EML
 *****************************************************************************/
function enablePreviewEditing() {
  const previewArea = document.getElementById('previewArea');
  const saveBtn = document.getElementById('savePreviewChanges');
  const notice = document.querySelector('.preview-edit-notice');

  if (!previewArea) return;

  if (previewArea.getAttribute('contenteditable') === 'false') {
    previewManuallyEdited = false;

    previewArea.setAttribute('contenteditable', 'true');
    previewArea.style.background = '#fff';
    previewArea.style.borderColor = '#ccc';
    previewArea.style.padding = '15px';
    previewArea.style.margin = '10px 0';

    if (saveBtn) saveBtn.style.display = 'inline-block';
    if (notice) notice.classList.add('visible');

    if (!previewArea.previousElementSibling?.classList.contains('customize-email')) {
      const customizeSection = document.createElement('div');
      customizeSection.className = 'customize-email';
      customizeSection.innerHTML = `
        <h3>Customize Email</h3>
        <div class="customize-field">
          <label for="customGreeting">Greeting</label>
          <input type="text"
                 id="customGreeting"
                 value="Hi ${escapeHTML(formData.addresseeName || '')},"
                 oninput="regeneratePreviewHTML()" />
        </div>
        <div class="customize-field">
          <label for="personalNote">Personal Note (Optional)</label>
          <textarea id="personalNote"
                    oninput="regeneratePreviewHTML()"></textarea>
        </div>
      `;
      previewArea.parentNode.insertBefore(customizeSection, previewArea);
    }

    regeneratePreviewHTML();
  }
}

function savePreviewEdits() {
  const previewArea = document.getElementById('previewArea');
  if (!previewArea) return;

  generatedEmailHTML = previewArea.innerHTML;
  previewManuallyEdited = true;
  alert('Preview changes saved.');
}

function buildEmlContent({ subject, from, to, htmlBody }) {
  const safeSubject = sanitizeHeaderValue(subject);
  const safeFrom = sanitizeHeaderValue(from);
  const safeTo = sanitizeHeaderValue(to);

  const boundary = '----=_MIME_' + Date.now() + '_' + Math.random().toString(16).slice(2);
  const sanitizedHtmlBody = sanitizeEmailHtmlForEml(htmlBody);
  const headers = [
    'Subject: ' + (safeSubject || ''),
    'From: ' + (safeFrom || ''),
    'To: ' + (safeTo || ''),
    'MIME-Version: 1.0',
    'Content-Type: multipart/alternative; boundary="' + boundary + '"',
    'X-Unsent: 1',
    ''
  ].join('\r\n');

  const bodyParts = [
    '--' + boundary,
    'Content-Type: text/plain; charset=UTF-8',
    'Content-Transfer-Encoding: 7bit',
    '',
    'This message contains HTML instructions. If you cannot view HTML, please ask your preparer for a plain-text version.',
    '',
    '--' + boundary,
    'Content-Type: text/html; charset=UTF-8',
    'Content-Transfer-Encoding: 7bit',
    '',
    '<!DOCTYPE html><html><head><meta charset="utf-8"/></head><body>' +
      sanitizedHtmlBody +
    '</body></html>',
    '',
    '--' + boundary + '--'
  ];

  return headers + bodyParts.join('\r\n');
}

function triggerEmlDownload(filename, emlContent) {
  const blob = new Blob([emlContent], { type: 'message/rfc822' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

function stripEmailPreviewHeader(html) {
  const raw = String(html ?? '');
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(raw, 'text/html');
    doc.querySelectorAll('.email-header').forEach(n => n.remove());
    return doc.body ? doc.body.innerHTML : raw;
  } catch {
    return raw;
  }
}

function downloadEmlFile() {
  upsertActiveClientFromForm();

  const previewArea = document.getElementById('previewArea');
  const finalHTML = previewArea ? previewArea.innerHTML : generatedEmailHTML || '';
  const exportHTML = stripEmailPreviewHeader(finalHTML);
  const subjectDate = formatDueDateForSubject(formData.paymentDueDate);
  const subject = `Tax Payment Instructions - Due ${subjectDate || ''}`;

  const emlContent = buildEmlContent({
    subject,
    from: '',
    to: '',
    htmlBody: exportHTML
  });

  triggerEmlDownload('TaxPaymentInstructions.eml', emlContent);
}

/******************************************************************************
 * 9) NEW: REPORT A BUG BUTTON
 *****************************************************************************/
function reportBug() {
  // This will open the default email client, which can include Outlook if installed.
  // You can customize the subject/body as desired:
  window.location.href = "mailto:kyle@milnertaxco.com?subject=Tax%20Payment%20Wizard%20Bug%20Report&body=Please%20describe%20the%20bug%20you%20encountered...";
}

/******************************************************************************
 * 10) PAGE INIT
 *****************************************************************************/
document.addEventListener('DOMContentLoaded', function() {
  initWizard().catch(err => {
    console.error(err);
  });
});

async function initWizard() {
  // Populate the state dropdown
  const sel = document.getElementById('addStateSelector');
  Object.keys(statesData).sort().forEach(st => {
    const opt = document.createElement('option');
    opt.value = st;
    opt.textContent = st;
    sel.appendChild(opt);
  });

  attachAutoPreviewListeners();

  const authed = await ensureAuthenticated();
  if (!authed) return;
  await loadSessionFromServer();

  const nameInput = document.getElementById('sessionNameInput');
  if (nameInput) {
    nameInput.addEventListener('input', () => saveSessionToStorage());
  }

  const aiInput = document.getElementById('assistantInput');
  if (aiInput) {
    aiInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        assistantSend();
      }
    });
  }

  if (session.clients.length) {
    activeClientId = session.clients[0].clientId;
    loadFormDataIntoUI(session.clients[0].data);
  } else {
    createNewClient();
  }

  renderSessionUI();
}

function updateReviewStep() {
  document.getElementById('review-addressee').textContent = formData.addresseeName || '(Not set)';
  document.getElementById('review-duedate').textContent = formData.paymentDueDate || '(Not set)';
  document.getElementById('review-sender').textContent = formData.senderName || '(Not set)';

  const fedReview = document.getElementById('review-federal');
  if (!formData.federalPayments.length) {
    fedReview.innerHTML = '<p>No federal payments added.</p>';
  } else {
    let html = '<ul style="margin:0; padding-left:20px;">';
    formData.federalPayments.forEach(p => {
      if (p.amount && p.amount.trim() !== '') {
        html += `<li>$${p.amount} - ${p.type}${p.quarter ? ' (' + p.quarter + ')' : ''}</li>`;
      } else {
        html += `<li>${p.type}${p.quarter ? ' (' + p.quarter + ')' : ''} - No amount entered</li>`;
      }
    });
    html += '</ul>';
    fedReview.innerHTML = html;
  }

  const stReview = document.getElementById('review-states');
  if (!formData.statePayments.length) {
    stReview.innerHTML = '<p>No state payments added.</p>';
  } else {
    let html = '';
    formData.statePayments.forEach(st => {
      if (st.payments?.length) {
        html += `<p><strong>${st.stateName}</strong></p><ul style="margin:0 0 16px; padding-left:20px;">`;
        st.payments.forEach(p => {
          if (p.amount && p.amount.trim() !== '') {
            html += `<li>$${p.amount} - ${p.type}${p.quarter ? ' (' + p.quarter + ')' : ''}</li>`;
          } else {
            html += `<li>${p.type}${p.quarter ? ' (' + p.quarter + ')' : ''} - No amount entered</li>`;
          }
        });
        html += '</ul>';
      }
    });
    html += html || '<p>No state payments added.</p>';
    stReview.innerHTML = html || '<p>No state payments added.</p>';
  }

  // Sync disclaimers checkbox in case user came back to this step
  document.getElementById('showDisclaimers').checked = formData.showDisclaimers;
}

/******************************************************************************
 * MISSING FUNCTIONS FOR TOGGLING BUSINESS FIELDS
 *****************************************************************************/
function onEntityTypeChange() {
  const val = document.getElementById('entityType').value;
  const businessFields = document.getElementById('businessFields');
  if (val === 'business') {
    businessFields.classList.remove('hidden');
  } else {
    businessFields.classList.add('hidden');
    // Clear out fields if reverting to individual
    document.getElementById('businessType').value = 'ccorp';
    document.getElementById('entityId').value = '';
    document.getElementById('entityName').value = '';
    document.getElementById('caCorpForm').value = '';
    document.getElementById('caCorpFormField').classList.add('hidden');
  }
  onFieldChange();
}

function onBusinessTypeChange() {
  const val = document.getElementById('businessType').value;
  const caCorpFormField = document.getElementById('caCorpFormField');
  if (val === 'ccorp' || val === 'scorp') {
    caCorpFormField.classList.remove('hidden');
  } else {
    caCorpFormField.classList.add('hidden');
    document.getElementById('caCorpForm').value = '';
  }
  onFieldChange();
}
</script>

<!--
README (inlined)

# Tax Payment Wizard

A single-page, browser-based tool that helps a tax preparer generate clear, client-ready electronic payment instructions for federal and state income tax payments.

The wizard walks you through four steps (Basic Info → Federal → State → Review) and produces a polished, editable email with step-by-step instructions and links for clients. It can also download an `.eml` file so you can open the message directly as a draft in your email client (Outlook, Apple Mail, etc.).

---

## Features

### Session (Multi-Client)

The wizard runs inside a **Session** that can contain multiple clients:

- Session controls in the header:
  - New Session
  - Save JSON / Load JSON
  - Export CSV / Import CSV
  - Download Draft Emails (.zip)
- Select an active client from the “Session Clients” dropdown to edit their email instructions.

### AI Assistant (Optional)

The “AI Assistant” panel can turn plain-English commands into session/client edits (creates/selects clients, fills fields, adds payments).

- The browser calls a backend endpoint at `/api/assistant` (so your API key is never in the HTML).
- To enable it locally, run `npm run dev` with `OPENAI_API_KEY` set, then open the wizard at `http://localhost:3000/wizard`.

### Multi-Step Wizard

1. **Step 1 – Basic Info**
   - Addressee (client name)
   - Sender (preparer name)
   - Pay-by date (must be a future date)
   - Toggle to include/exclude a due date reminder in the email
   - Entity type:
     - Individual
     - Business Entity
   - Business-only fields (shown when entity = “Business”):
     - Business type (C-Corp, S-Corp, Partnership, LLC)
     - Entity ID
     - Entity Name
     - California corporate form (Form 100, 100S, 100W, 100X) for CA C-Corps and S-Corps

2. **Step 2 – Federal Payments**
   - Add any number of federal payments:
     - Type: Extension, Estimated, or Balance Due
     - Quarter (only enabled for Estimated payments)
     - Due date
     - Amount
     - Tax period
     - Notes
   - Logic changes instructions based on:
     - Individual vs Business
     - Payment type (4868 vs 7004, 1040-ES vs 1120-W, 1040 vs 1120)

3. **Step 3 – State Payments**
   - Add one or more states from a dropdown.
   - For each state:
     - Add multiple payments
     - Payment type (Extension, Estimated, Balance Due, PTE, etc.)
     - Payment method:
       - Electronic
       - Pay by mail
     - Quarter (enabled for “Estimated” types)
     - Due date
     - Amount
     - Tax year
     - Notes
   - State overview box:
     - Shows basic info, tax agency name, estimated tax rules, extension info, PTE notes, payment portal URL, and comments.
   - Special logic for **California**:
     - Separate payment type maps for:
       - C-Corp / S-Corp (`corpScorpPaymentTypes`)
       - LLCs (`llcPaymentTypes`)
       - Partnerships (`partnershipPaymentTypes`)
     - Handles CA PTE (Form 3893) and other specific payment types.
   - Placeholder/summary data for all other states to keep instructions reasonably correct at a high level.

4. **Step 4 – Review & Confirm**
   - Summary of:
     - Basic info (addressee, due date, sender)
     - Federal payments (type, quarter, amounts)
     - State payments (by state and payment type)
   - Toggle to include or remove “Important Notes & References” disclaimers in the final email.
   - Button to “Enable Final Edits”:
     - Turns the preview into an editable area.
     - Opens a small “Customize Email” section to adjust:
       - Greeting
       - Personal note
   - Button to download an `.eml` file (“Open as Draft Email”).

---

## Live Email Preview

The right-hand sidebar shows a **live email preview** as you fill out the wizard:

- Header (From, To, Subject)
- Body with:
  - Greeting
  - Due date reminder (optional)
  - Detailed federal payment instructions (with IRS Direct Pay steps)
  - Detailed state payment instructions (with state portal links)
  - Optional personal note
  - Optional “Important Notes & References” section:
    - Extension vs payment reminder
    - Correct tax year/form selection
    - Payment confirmation best practices
    - Links to IRS Direct Pay and CA FTB Web Pay

You can enable final editing to tweak the message directly before downloading the `.eml`.

---

## Technology Stack

- **HTML5** – Single static file (`tax_payment_wizard_new.html`)
- **CSS** – Embedded styles for layout and UI (grid layout, sticky preview, stepper, etc.)
- **Vanilla JavaScript** – No external dependencies:
  - Manages wizard navigation and validation
  - Maintains in-memory `formData` model
  - Builds HTML email content
  - Generates `.eml` files
  - Implements special logic for state payment types and entity types

There is no build step, bundler, or framework. This is designed to run as a simple static page in any modern browser.

---

## Getting Started

### 1. Open the Wizard Locally

If you just want to run it from your machine:

1. Locate `tax_payment_wizard_new.html`.
2. Double-click to open it in your browser, or right-click and choose “Open With” → your preferred browser.

Optionally, you can serve it via a simple static server (e.g. `python -m http.server` in the project folder) if the browser restricts file URLs or you want a more realistic environment.

### 2. Optional: Host It

You can put this file on any static hosting solution:

- GitHub Pages
- Vercel / Netlify
- Simple Apache/Nginx static site

Just ensure the file is accessible over HTTPS so all links and behavior work cleanly.

---

## Usage Guide

### Step 1 – Basic Info

1. Enter **Recipient** and **Sender**.
2. Choose the **Pay-by date**.
3. Decide whether to show the due date in the client email.
4. Choose **Individual** or **Business**:
   - If Business:
     - Pick your business type.
     - For CA C-Corp/S-Corp, choose the appropriate CA corporate form.
     - Enter entity name and ID.

Click **Next Step**.

### Step 2 – Federal Payments

1. Click **“+ Add Federal Payment”** for each payment you want to include.
2. For each payment:
   - Choose a **Type**:
     - Extension
     - Estimated
     - Balance Due
   - If Estimated, select the **Quarter**.
   - Enter **Due Date**, **Amount**, **Tax Period**, and any **Notes**.
3. The preview will show:
   - A highlighted “Please pay $X to the US Treasury” banner.
   - IRS Direct Pay instructions tailored to:
     - Individual vs Business
     - Type of payment (4868, 1040-ES, 1040, 7004, 1120-W, 1120)

Click **Next** when finished.

### Step 3 – State Payments

1. Use the “Select a State to Add” dropdown to pick any state.
2. For each state you add:
   - Use **“+ Add Payment”** to create one or more state payments.
   - If the entity is a business and the state supports PTE, you may also see **“+ Add PTE Payment”**.
3. For each payment:
   - Choose **Payment Type** (dynamic options for CA business entities; generic options elsewhere).
   - Choose **Method**:
     - Electronic – client will pay via state portal.
     - Pay by Mail – client will mail a check (with a state voucher from the portal/notice if required).
   - Fill in **Quarter** (if “Estimated” type), **Due Date**, **Amount**, **Tax Year**, and **Notes**.
4. The state info box on the same step gives you quick reference for that state’s:
   - Tax agency name
   - Estimated tax requirements
   - Extension rules
   - PTE overview
   - Payment portal URL
   - Additional comments

Click **Next** when finished.

### Step 4 – Review & Finalize

1. Review the **Basic Information**, **Federal Payments**, and **State Payments** summaries.
2. Decide whether to keep or remove the **“Important Notes & References”** section.
3. Click **“Enable Final Edits”** if you want to:
   - Edit the email greeting.
   - Add/revise a personal note.
   - Manually tweak text in the preview.

When ready:

- Click **“Open as Draft Email”** to download an `.eml` file.
- Open the `.eml` file in your email client.
- Confirm recipients, add CC/BCC as needed, and send.

---

## Data Model Overview

The JavaScript maintains a `formData` object with:

- `addresseeName`, `senderName`, `paymentDueDate`, `showDueDateReminder`
- `entityType`, `businessType`, `entityId`, `entityName`, `caCorpForm`
- `federalPayments`: array of payment objects:
  - `type`, `quarter`, `dueDate`, `amount`, `description`, `taxPeriod`
- `statePayments`: array of state objects:
  - `stateName`
  - `payments`: array of payment objects:
    - `type`, `quarter`, `dueDate`, `amount`, `description`, `taxPeriod`, `method`
- `showDisclaimers`: toggle for the disclaimer block

There is also a `statesData` object that contains per-state metadata: form names, payment URLs, and notes.

---

## Developer Notes

- **Session persistence (LocalStorage)**:
- The current session is saved to the server via `/api/batches/current` for the logged-in user.
- Use “Save JSON” / “Load JSON” to export/import the full session (clients + payments).
  - Use “Export CSV” / “Import CSV” for a flat, one-row-per-payment format (grouped by `ClientId`).

- **Validation**:
  - Each step validates required fields before you can move forward.
  - Error messages appear inline under fields that fail validation.

- **Extending State Logic**:
  - To refine or correct state behavior, edit the `statesData` object.
  - For state-specific logic (e.g., CA business payment types), add or adjust entries in the `stateLogic` object.
  - `getStatePaymentTypeMap(stateName)` is the hook used when rendering state payment options.

- **Disclaimers section**:
  - Controlled by `formData.showDisclaimers` and the checkbox on the Review step.
  - The HTML for the disclaimer block is appended near the end of `buildEmailHTML()`.

- **AI Assistant**:
  - The front-end posts to `/api/assistant` and applies the returned `actions[]` plan to your session and active client.
  - Use the Next.js server with `OPENAI_API_KEY` set (keeps your OpenAI API key off the client).

- **Bug Reporting button**:
  - “Report a Bug” in the header triggers `mailto:kyle@milnertaxco.com` with a pre-filled subject and body.

---

## Known Limitations / Future Ideas

- State data for some jurisdictions is summarized and may need ongoing maintenance as laws or portals change.
- Server-backed persistence with authenticated access.
- Credentials-based authentication for local use (upgradeable to OAuth).
- Potential future enhancements:
  - Integrate with a practice management system or CRM via API.
  - Read client details from a JSON file or API (so you don’t retype names/entity info).
  - Add preset templates for common payment “packages” (e.g., standard 1040 extension + CA extension).
  - Localize date formats and language if used outside the US.

---

© 2026 Kyle Milner. All rights reserved.
-->
</body>
</html>
